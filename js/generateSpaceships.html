<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<HEAD>
<META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset=windows-1252">
<TITLE>Procedural spaceships</TITLE>
<META NAME="AUTHOR" CONTENT="green_meklar">
<style type="text/css">
p {margin-bottom:0cm;color:#cccccc;font-size:10pt;}
td {margin-bottom:0cm;color:#cccccc;font-size:10pt;}
a:link {color:#00ae00;background:transparent;}
a.western:link {font-weight:bold;}
a:visited {color:#008000;}
h1 {margin-bottom:0cm;color:#cccccc;font-size:12pt;font-weight:bold;color:#ffffff;}
</style>
<script type="text/javascript">
var pi=Math.PI;
var pi2=pi*2;
var pih=pi*0.5;
var piq=pi*0.25;
var inf=Number.POSITIVE_INFINITY;
var ninf=Number.NEGATIVE_INFINITY;

function largest(a) //Returns the number in the array a with the greatest magnitude.
{
 if(a.length<=0)
 {
  return 0;
 }
 var found=a[0];
 var foundabs=Math.abs(a[0]);
 for(var i=1;i<a.length;i++)
 {
  var next=a[i];
  var nextabs=Math.abs(a[i]);
  if(nextabs>foundabs)
  {
   found=next;
   foundabs=nextabs;
  }
 }
 return found;
}

function smallest(a) //Returns the number in the array a with the lowest magnitude.
{
 if(a.length<=0)
 {
  return 0;
 }
 var found=a[0];
 var foundabs=Math.abs(a[0]);
 for(var i=1;i<a.length;i++)
 {
  var next=a[i];
  var nextabs=Math.abs(a[i]);
  if(nextabs<foundabs)
  {
   found=next;
   foundabs=nextabs;
  }
 }
 return found;
}

function clamp(n,min,max)
{
 return Math.max(min,Math.min(max,n));
}

function modc(n,d)
{
 return (((n%d)+d)%d);
}

function arraycontains(a,f)
{
 for(var i=a.length-1;i>=0;i--)
 {
  if(a[i]==f)
  {
   return true;
  }
 }
 return false;
}

function copyarray(a)
{
 var rv=new Array(a.length);
 for(var i=a.length-1;i>=0;i--)
 {
  rv[i]=a[i];
 }
 return rv;
}

function copyarray(a,i0,i1)
{
 var rv=new Array(i1-i0);
 for(var i=i1;i>=i0;i--)
 {
  rv[i-i0]=a[i];
 }
 return rv;
}

function hashi(seed)
{
 var t=1206170165;
 for(var x=seed.length-1;x>=0;x--)
 {
  var c=seed.charCodeAt(x);
  t=((t<<5)+t)^c^(t<<((c%13)+1))^(t>>((c%17)+1));
 }
 return (t>>>0);
}

function hashd(seed)
{
 return (((hashi("."+seed)*4294967296)+hashi(seed))/18446744073709551616);
}

function zi(min,max,seed)
{
 if(seed==null)
 {
  return(Math.floor(min+(Math.random()*(1+(max-min)))));
 }
 else
 {
  return(Math.floor(min+(hashd(seed)*(1+(max-min)))));
 }
}

function zd(min,max,seed)
{
 if(seed==null)
 {
  return(min+(Math.random()*(max-min)));
 }
 else
 {
  return(min+(hashd(seed)*(max-min)));
 }
}

//START RANDOMIZER

function randomizer(p_seed)
{
 this.seed=p_seed;
 this.seedlen=this.seed.length;
 if(this.seedlen<8)
 {
  this.seed="padding_"+this.seed;
  this.seedlen=this.seed.length;
 }
 if(this.seedlen%2==0)
 {
  this.seed="1"+this.seed;
  this.seedlen=this.seed.length;
 }
 this.statearray=[2972948403,3086140710,2071788248,3026137486,1411764137,2265725585,2923087685,1593177610];
 this.state=3234042090;
 for(var i=this.seedlen-1;i>=0;i--)
 {
  var c=this.seed.charCodeAt(i);
  this.state=(((this.state<<5)+this.state)^c^(this.state<<((c%13)+1))^(this.state>>((c%17)+1)))>>>0;
  this.statearray[i%8]^=(((this.state>>9)*((this.state%16384)+3427))^c)>>>0;
 }
 this.seedposition=0;
 this.arrayposition=0;
}

randomizer.prototype.sr=function() //Returns a raw unsigned 32-bit integer from the stream.
{
 var c=this.seed.charCodeAt(this.seedposition);
 var lsa=this.statearray[this.arrayposition];
 this.state=(((this.state<<5)+this.state+lsa)^c^(this.state<<((c%17)+1))^(this.state>>((c%13)+1)))>>>0;
 this.statearray[this.arrayposition]=((lsa>>3)^(lsa<<((c%19)+1))^((this.state%134217728)*3427))>>>0;
 this.seedposition=(this.seedposition+1)%this.seedlen;
 this.arrayposition=(this.arrayposition+1)%8;
 return this.state;
}

randomizer.prototype.hr_original=function(s) //Returns a raw unsigned 32-bit integer based on hashing this object's seed with the specified string.
{
 var t=1206170165;
 if(s!=null)
 {
  for(var x=s.length-1;x>=0;x--)
  {
   var c=s.charCodeAt(x);
   t=((t<<5)+t)^c^(t<<((c%13)+1))^(t>>((c%17)+1));
  }
 }
 for(var y=this.seedlen-1;y>=0;y--)
 {
  var c=this.seed.charCodeAt(y);
  t=((t<<5)+t)^c^(t<<((c%13)+1))^(t>>((c%17)+1));
 }
 return (t>>>0);
}

randomizer.prototype.hr_xorshift=function(s) //Returns a raw unsigned 32-bit integer based on hashing this object's seed with the specified string.
{
 var state=[1160605769,1424711319,876532818,1419174464];
 var rv=1206170165;
 if(s==null)
 {
  s="?/?/?/";
  rv=3379896793;
 }
 for(var x=s.length-1;x>=0;x--)
 {
  var c=s.charCodeAt(x);
  var t=state[0]^c;
  t=(t^(t<<11))>>>0;
  t=(t^(t>>8))>>>0;
  state[0]=state[1];
  state[1]=state[2];
  state[2]=state[3];
  state[3]=(state[3]^(state[3]>>19)^t)>>>0;
  rv=((rv^(c<<24))*3427)^state[3];
 }
 for(var y=this.seedlen-1;y>=0;y--)
 {
  var c=this.seed.charCodeAt(y);
  var t=state[0]^c;
  t=(t^(t<<11))>>>0;
  t=(t^(t>>8))>>>0;
  state[0]=state[1];
  state[1]=state[2];
  state[2]=state[3];
  state[3]=(state[3]^(state[3]>>19)^t)>>>0;
  rv=((rv^(c<<24))*3427)^state[3];
 }
 return (rv>>>0);
}

randomizer.prototype.hr=randomizer.prototype.hr_xorshift;

randomizer.prototype.sd=function(min,max) //Returns a double between the specified minimum and maximum, from the stream.
{
 return (((((this.sr()*4294967296)+this.sr())/18446744073709551616)*(max-min))+min);
}

randomizer.prototype.hd=function(min,max,s) //Returns a double between the specified minimum and maximum, by hashing this object's seed with the specified string.
{
 return (((((this.hr(s)*4294967296)+this.hr(s+"@"))/18446744073709551616)*(max-min))+min);
}

randomizer.prototype.si=function(min,max) //Returns an integer between the specified minimum and maximum, from the stream.
{
 return Math.floor(((((this.sr()*4294967296)+this.sr())/18446744073709551616)*(max+1-min))+min);
}

randomizer.prototype.hi=function(min,max,s) //Returns an integer between the specified minimum and maximum, by hashing this object's seed with the specified string.
{
 return Math.floor(((((this.hr(s)*4294967296)+this.hr(s+"@"))/18446744073709551616)*(max+1-min))+min);
}

randomizer.prototype.sb=function(chance) //Returns a boolean with the specified chance of being true (and false otherwise), from the stream.
{
 return ((((this.sr()*4294967296)+this.sr())/18446744073709551616)<chance);
}

randomizer.prototype.hb=function(chance,s) //Returns a boolean with the specified chance of being true (and false otherwise), by hashing this object's seed with the specified string.
{
 return ((((this.hr(s)*4294967296)+this.hr(s+"@"))/18446744073709551616)<chance);
}

randomizer.prototype.ss=function(chance) //Returns an integer with the specified chance of being -1 (and 1 otherwise), from the stream.
{
 return ((((this.sr()*4294967296)+this.sr())/18446744073709551616)<chance?-1:1);
}

randomizer.prototype.hs=function(chance,s) //Returns an integer with the specified chance of being -1 (and 1 otherwise), by hashing this object's seed with the specified string.
{
 return ((((this.hr(s)*4294967296)+this.hr(s+"@"))/18446744073709551616)<chance?-1:1);
}

randomizer.prototype.sseq=function(chance,max) //Returns an integer {0,1,2,...}, starting from 0, with the specified chance of advancing to each successive integer, from the stream.
{
 var rv=0;
 while((((this.sr()*4294967296)+this.sr())/18446744073709551616)<chance && rv<max) {rv++;}
 return rv;
}

randomizer.prototype.hseq=function(chance,max,s) //Returns an integer {0,1,2,...}, starting from 0, with the specified chance of advancing to each successive integer, by hashing this object's seed with the specified string.
{
 var rv=0;
 while((((this.hr(s+rv)*4294967296)+this.hr(s+"@"+rv))/18446744073709551616)<chance && rv<max) {rv++;}
 return rv;
}

randomizer.prototype.schoose=function(chances) //Returns an index of the array chances with the relative probability equal to that element of chances, based on a stream value.
{
 var sum=0;
 for(var i=0;i<chances.length;i++)
 {
  sum+=chances[i];
 }
 var which=this.sd(0,sum);
 for(var j=0;j<chances.length;j++)
 {
  which-=chances[j];
  if(which<0)
  {
   return j;
  }
 }
 return 0;
}

randomizer.prototype.hchoose=function(chances,s) //Returns an index of the array chances with the relative probability equal to that element of chances, based on a hash value with the specified seed.
{
 var sum=0;
 for(var i=0;i<chances.length;i++)
 {
  sum+=chances[i];
 }
 var which=this.hd(0,sum,s);
 for(var j=0;j<chances.length;j++)
 {
  which-=chances[j];
  if(which<0)
  {
   return j;
  }
 }
 return 0;
}

//END RANDOMIZER

//START VECTOR MATH

var vec={};

vec.length=vec.length_euclidean=function(v)
{
 var sum=0;
 for(var i=0;i<v.length;i++)
 {
  sum+=v[i]*v[i];
 }
 return Math.sqrt(sum);
}

vec.distance=vec.distance_euclidean=function(v0,v1)
{
 var n=Math.max(v0.length,v1.length)
 var sum=0;
 for(var i=0;i<n;i++)
 {
  var diff=(i<v0.length?v0[i]:0)-(i<v1.length?v1[i]:0);
  sum+=diff*diff;
 }
 return Math.sqrt(sum);
}

vec.add=function(vl) //Where vl is an array of vectors.
{
 var r=[];
 for(var i=0;i<vl.length;i++)
 {
  for(var j=0;j<vl[i].length;j++)
  {
   if(r[j]==null)
   {
    r[j]=vl[i][j];
   }
   else
   {
    r[j]+=vl[i][j];
   }
  }
 }
 return r;
}

vec.subtract=function(v0,v1)
{
 var r=[];
 var m=Math.max(v0.length,v1.length);
 for(var i=0;i<m;i++)
 {
  if(v0[i]==null)
  {
   r[i]=0-v1[i];
  }
  else if(v1[i]==null)
  {
   r[i]=v0[i];
  }
  else
  {
   r[i]=v0[i]-v1[i];
  }
 }
 return r;
}

vec.average=function(vl) //Where vl is an array of vectors.
{
 var r=[];
 for(var i=0;i<vl.length;i++)
 {
  for(var j=0;j<vl[i].length;j++)
  {
   if(r[j]==null)
   {
    r[j]=vl[i][j];
   }
   else
   {
    r[j]+=vl[i][j];
   }
  }
 }
 var f=1/vl.length;
 for(var j=0;j<r.length;j++)
 {
  r[j]*=f;
 }
 return r;
}

vec.scaleby=function(v,n) //Where v is a vector and n is a scalar value.
{
 var r=[];
 for(var i=0;i<v.length;i++)
 {
  r[i]=v[i]*n;
 }
 return r;
}

vec.scaleto=function(v,n) //Where v is a vector and n is a scalar value.
{
 var sum=0;
 for(var i=0;i<v.length;i++)
 {
  sum+=(v[i]*v[i]);
 }
 var r=[];
 if(sum==0)
 {
  var nc=n/v.length;
  for(var j=0;j<v.length;j++)
  {
   r[j]=nc;
  }
 }
 else
 {
  var len=Math.sqrt(sum);
  var f=n/len;
  for(var j=0;j<v.length;j++)
  {
   r[j]=v[j]*f;
  }
 }
 return r;
}

vec.normalize=function(v)
{
 return this.scaleto(v,1);
}

vec.dot=function(v0,v1)
{
 var r=0;
 for(var i=Math.min(v0.length,v1.length)-1;i>=0;i--)
 {
  r+=v0[i]*v1[i];
 }
 return r;
}

vec.angle=function(v0,v1)
{
 return Math.abs(Math.acos(Math.max(-1,Math.min(1,vec.dot(vec.normalize(v0),vec.normalize(v1))))));
}

var metric={};

metric.euclidean=function(v)
{
 var sum=0;
 for(var i=0;i<v.length;i++)
 {
  sum+=v[i]*v[i];
 }
 return Math.sqrt(sum);
}

metric.manhattan=function(v)
{
 var sum=0;
 for(var i=0;i<v.length;i++)
 {
  sum+=Math.abs(v[i]);
 }
 return sum;
}

metric.chessboard=function(v)
{
 var longest=0;
 for(var i=0;i<v.length;i++)
 {
  longest=Math.max(longest,Math.abs(v[i]));
 }
 return longest;
}

//END VECTOR MATH

//START COLOR MATH

var color={};

color.tohex=function(c)
{
 return (("#"+hexpad(Math.floor(clamp(c[0],0,1)*255),2))+(hexpad(Math.floor(clamp(c[1],0,1)*255),2)+hexpad(Math.floor(clamp(c[2],0,1)*255),2)));
}

color.scaleby=function(c,n) //Where c is a color and n is the amount to multiply by. n = 0 produces black.
{
 return [c[0]*n,c[1]*n,c[2]*n];
}

color.hsv_rgb=function(hsv) //Takes a triplet [H,S,V] and returns a triplet [R,G,B], representing the same color. All components are 0 - 1.
{
 var c=hsv[1]*hsv[2];
 var m=hsv[2]-c;
 var h=((hsv[0]%1)+1)%1;
 var hrel=6*h;
 var hseg=Math.floor(hrel);
 var x=c*(1-Math.abs((hrel%2)-1));
 switch(hseg)
 {
  case 0:
   return [c+m,x+m,m];
  case 1:
   return [x+m,c+m,m];
  case 2:
   return [m,c+m,x+m];
  case 3:
   return [m,x+m,c+m];
  case 4:
   return [x+m,m,c+m];
  default:
   return [c+m,m,x+m];
 }
}

//END COLOR MATH

function hexpad(n,l) //For integer n and length l.
{
 var s=Math.floor(n).toString(16);
 while(s.length<l)
 {
  s="0"+s;
 }
 return s;
}

function simplecolor(r,g,b)
{
 if(b==null)
 {
  b=r;
 }
 if(g==null)
 {
  g=r;
 }
 return ("#"+hexpad(r,2)+hexpad(g,2)+hexpad(b,2));
}

var characters="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";

function randomseed(n,seed)
{
 var s="";
 for(var x=0;x<n;x++)
 {
  s=s+characters[zi(0,characters.length-1,seed+"_"+x)];
 }
 return s;
}

function element(id)
{
 return document.getElementById(id);
}



var renderdelay=0; //Number of milliseconds between render calls.
var renderspeed=1; //Number of components to render on each call.

//START SHIP

var cgridsize=6; //Size of the component grid.
var cgridsizen=0-cgridsize;

function ship(p_faction,p_seed)
{
 this.f=p_faction;
 this.bs=p_seed; //Base seed for this ship, without appending the faction seed.
 this.s=this.f.s+this.bs;
 this.r=new randomizer(this.s);
 this.c=[]; //Data cache.
 this.size=Math.pow(this.r.sd((this.f.c["size min"]==null?this.f.c["size min"]=this.f.r.hd(2.5,3.5,"size min"):this.f.c["size min"]),(this.f.c["size max"]==null?this.f.c["size max"]=this.f.r.hd(5,7,"size max"):this.f.c["size max"])),3); //The initial overall size of this ship, in pixels.
 var wratio=this.r.sd((this.f.c["wratio min"]==null?this.f.c["wratio min"]=this.f.r.hd(0.5,1,"wratio min"):this.f.c["wratio min"]),(this.f.c["wratio max"]==null?this.f.c["wratio max"]=this.f.r.hd(1,1.3,"wratio max"):this.f.c["wratio max"]));
 var hratio=this.r.sd((this.f.c["hratio min"]==null?this.f.c["hratio min"]=this.f.r.hd(0.7,1,"hratio min"):this.f.c["hratio min"]),(this.f.c["hratio max"]==null?this.f.c["hratio max"]=this.f.r.hd(1.1,1.7,"hratio max"):this.f.c["hratio max"]));
 this.w=Math.floor(this.size*wratio)+csedge2; //Maximum width of this ship, in pixels.
 this.hw=Math.floor(this.w/2);
 this.gw=Math.floor((this.w-csedge2)/cgridsize);
 this.gwextra=(this.w-(this.gw*cgridsize))*0.5;
 this.h=Math.floor(this.size*hratio)+csedge2; //Maximum height of this ship, in pixels.
 this.hh=Math.floor(this.h/2);
 this.gh=Math.floor((this.h-csedge2)/cgridsize);
 this.ghextra=(this.h-(this.gh*cgridsize))*0.5;
 this.cs=document.createElement("canvas"); //Canvas on which the basic outline of the ship is drawn. Ships face upwards, with front towards Y=0.
 this.cs.setAttribute("width",this.w);
 this.cs.setAttribute("height",this.h);
 this.csx=this.cs.getContext("2d");
 this.cf=document.createElement("canvas"); //Canvas on which the actual ship components are drawn. Ships face upwards, with front towards Y=0.
 this.cf.setAttribute("width",this.w);
 this.cf.setAttribute("height",this.h);
 this.cfx=this.cf.getContext("2d");
 this.text="";
 outlines[this.f.r.hchoose([1,1,1],"outline type")](this);
 this.csd=this.csx.getImageData(0,0,this.w,this.h);
 this.cgrid=[];
 for(var gx=0;gx<this.gw;gx++)
 {
  this.cgrid[gx]=[];
  for(var gy=0;gy<this.gh;gy++)
  {
   this.cgrid[gx][gy]={"gx":gx,"gy":gy,"x":Math.floor(this.gwextra+((gx+0.5)*cgridsize)),"y":Math.floor(this.ghextra+((gy+0.5)*cgridsize)),"state":0}; //state is 0 for unchecked, 1 for checked and good, and -1 for checked and bad.
  }
 }
 this.goodcells=[this.cgrid[Math.floor(this.gw/2)][Math.floor(this.gh/2)]];
 var nextcheck=0;
 while(nextcheck<this.goodcells.length)
 {
  var lcell=this.goodcells[nextcheck];
  if(lcell.gx>0)
  {
   var ncell=this.cgrid[lcell.gx-1][lcell.gy];
   if(ncell.state==0)
   {
    if(this.getspa(ncell.x,ncell.y)>0)
    {
     ncell.state=1;
     this.goodcells.push(ncell);
    }
    else
    {
     ncell.state=-1;
    }
   }
  }
  if(lcell.gx<this.gw-1)
  {
   var ncell=this.cgrid[lcell.gx+1][lcell.gy];
   if(ncell.state==0)
   {
    if(this.getspa(ncell.x,ncell.y)>0)
    {
     ncell.state=1;
     this.goodcells.push(ncell);
    }
    else
    {
     ncell.state=-1;
    }
   }
  }
  if(lcell.gy>0)
  {
   var ncell=this.cgrid[lcell.gx][lcell.gy-1];
   if(ncell.state==0)
   {
    if(this.getspa(ncell.x,ncell.y)>0)
    {
     ncell.state=1;
     this.goodcells.push(ncell);
    }
    else
    {
     ncell.state=-1;
    }
   }
  }
  if(lcell.gy<this.gh-1)
  {
   var ncell=this.cgrid[lcell.gx][lcell.gy+1];
   if(ncell.state==0)
   {
    if(this.getspa(ncell.x,ncell.y)>0)
    {
     ncell.state=1;
     this.goodcells.push(ncell);
    }
    else
    {
     ncell.state=-1;
    }
   }
  }
  nextcheck++;
 }
 for(var i=0;i<this.goodcells.length;i++)
 {
  var lcell=this.goodcells[i];
  var ocell=this.cgrid[(this.gw-1)-lcell.gx][lcell.gy];
  if(ocell.state!=1)
  {
   ocell.state=1;
   this.goodcells.push(ocell);
  }
 }
 this.passes=this.f.r.hi(1,2,"base component passes");
 this.extra=Math.max(1,Math.floor(this.goodcells.length*this.f.r.hd(0,1/this.passes,"extra component amount")));
 this.extradone=0;
 this.nextpass=0;
 this.nextcell=0;
 this.totalcomponents=(this.passes*this.goodcells.length)+this.extra;
 this.totaldone=0;
}

ship.prototype.getcell=function(x,y) //Returns the cell containing (X,Y), if there is one, or null otherwise.
{
 var gx=Math.floor((x-this.gwextra)/cgridsize);
 var gy=Math.floor((y-this.ghextra)/cgridsize);
 if(gx<0 || gx>=this.gw || gy<0 || gy>=this.gh)
 {
  return null;
 }
 return this.cgrid[gx][gy];
}

ship.prototype.getcellstate=function(x,y) //Returns the state of the cell containing (X,Y), or 0 if there is no such cell.
{
 var lcell=this.getcell(x,y);
 if(lcell==null)
 {
  return 0;
 }
 return lcell.state;
}

ship.prototype.getspa=function(x,y) //Returns the alpha value (0 - 255) for the pixel of csd corresponding to the point (X,Y), or -1 if (X,Y) is out of bounds.
{
 x=Math.floor(x);
 y=Math.floor(y);
 if(x<0 || x>this.w || y<0 || y>this.h)
 {
  return -1;
 }
 return this.csd.data[(((y*this.w)+x)*4)+3];
}

ship.prototype.getpcdone=function()
{
 return (this.totaldone/this.totalcomponents);
}

ship.prototype.addcomponent=function() //Generates the next component of this ship. Returns true if the ship is finished, false if there are still more components to add.
{
 var ncell;
 if(this.nextpass<this.passes)
 {
  if(this.nextcell<this.goodcells.length)
  {
   ncell=this.goodcells[this.nextcell];
   this.nextcell++;
  }
  else
  {
   this.nextpass++;
   ncell=this.goodcells[0];
   this.nextcell=1;
  }
 }
 else if(this.extradone<this.extra)
 {
  ncell=this.goodcells[this.r.si(0,this.goodcells.length-1)];
  this.extradone++;
 }
 else
 {
  return true;
 }
 var lv=[ncell.x,ncell.y];
 for(var t=0;t<10;t++)
 {
  var nv=[ncell.x+this.r.si(cgridsizen,cgridsize),ncell.y+this.r.si(cgridsizen,cgridsize)];
  if(nv[0]<csedge || nv[0]>this.w-csedge || nv[1]<csedge || nv[1]>this.h-csedge)
  {
   continue;
  }
  if(this.getspa(nv[0],nv[1])<=0)
  {
   continue;
  }
  lv=nv;
  break;
 }
 if(Math.abs(lv[0]-this.hw)<cgridsize)
 {
  if(this.r.sb(this.f.c["com middleness"]==null?this.f.c["com middleness"]=this.f.r.hd(0,1,"com middleness"):this.f.c["com middleness"]))
  {
   lv[0]=Math.floor(this.hw);
  }
 }
 components[this.r.schoose(this.f.cchances)](this,lv);
 this.totaldone++;
 return false;
}

//START OUTLINES

var csedge=24; //Minimum distance between the edge of the ship outline and the edge of the canvas.
var csedge2=csedge*2;

var outlines=[]; //Each outline function takes a single argument 'lp' denoting the ship to draw the outline for.

outlines[0]=function(lp) //Joined rectangles.
{
 var csarea=(lp.w-csedge2)*(lp.h-csedge2);
 var csarealimit=csarea*0.05;
 var initialwidth=Math.ceil((lp.w-csedge2)*(lp.f.c["outline0 iw"]==null?lp.f.c["outline0 iw"]=lp.f.r.hd(0.1,1,"outline0 iw"):lp.f.c["outline0 iw"])*0.2);
 var blocks=[[[lp.hw-initialwidth,csedge],[lp.hw+initialwidth,lp.h-csedge]]];
 if(lp.f.c["outline0 bc"]==null) {lp.f.c["outline0 bc"]=lp.f.r.hd(2,8,"outline0 bc");}
 var blockcount=2+Math.floor(lp.r.sd(0.5,1)*lp.f.c["outline0 bc"]*Math.sqrt(lp.size));
 for(var i=1;i<blockcount;i++)
 {
  var base=blocks[lp.r.si(0,blocks.length-1)];
  var v0=[base[0][0]+(lp.r.sd(0,1)*(base[1][0]-base[0][0])),base[0][1]+(lp.r.sd(0,1)*(base[1][1]-base[0][1]))];
  if(v0[1]<((base[0][1]+base[1][1])*0.5) && lp.r.sb(lp.f.c["outline0 frontbias"]==null?lp.f.c["outline0 frontbias"]=lp.f.r.hd(0.5,1.5,"outline0 frontbias"):lp.f.c["outline0 frontbias"]))
  {
   v0[1]=base[1][1]-(v0[1]-base[0][1]);
  }
  var v1=[clamp(lp.r.sd(0,1)*lp.w,csedge,lp.w-csedge),clamp(lp.r.sd(0,1)*lp.h,csedge,lp.h-csedge)];
  var area=Math.abs((v1[0]-v0[0])*(v1[1]-v0[1]));
  var ratio=csarealimit/area;
  if(ratio<1)
  {
   v1[0]=v0[0]+((v1[0]-v0[0])*ratio);
   v1[1]=v0[1]+((v1[1]-v0[1])*ratio);
  }
  if(v0[0]>v1[0]) {var t=v0[0]; v0[0]=v1[0]; v1[0]=t;}
  if(v0[1]>v1[1]) {var t=v0[1]; v0[1]=v1[1]; v1[1]=t;}
  blocks.push([[Math.floor(v0[0]),Math.floor(v0[1])],[Math.ceil(v1[0]),Math.ceil(v1[1])]]);
 }
 lp.csx.fillStyle="#FFFFFF";
 for(var i=0;i<blocks.length;i++)
 {
  var lb=blocks[i];
  lp.csx.fillRect(lb[0][0],lb[0][1],lb[1][0]-lb[0][0],lb[1][1]-lb[0][1]);
  lp.csx.fillRect(lp.w-lb[1][0],lb[0][1],lb[1][0]-lb[0][0],lb[1][1]-lb[0][1]);
 }
}

outlines[1]=function(lp) //Joined circles.
{
 var csarea=(lp.w-csedge2)*(lp.h-csedge2);
 var csarealimit=csarea*0.05;
 var csrlimit=Math.max(2,Math.sqrt(csarealimit/pi));
 var initialwidth=Math.ceil((lp.w-csedge2)*(lp.f.c["outline1 iw"]==null?lp.f.c["outline1 iw"]=lp.f.r.hd(0.1,1,"outline1 iw"):lp.f.c["outline1 iw"])*0.2);
 var circles=[];
 var initialcount=Math.floor((lp.h-csedge2)/(initialwidth*2));
 for(var i=0;i<initialcount;i++)
 {
  var lv=[lp.hw,lp.h-(csedge+(initialwidth*((i*2)+1)))];
  circles.push({"v":lv,"r":initialwidth});
 }
 if(lp.f.c["outline1 cc"]==null) {lp.f.c["outline1 cc"]=lp.f.r.hd(10,50,"outline1 cc");}
 var circlecount=initialcount+Math.floor(lp.r.sd(0.5,1)*lp.f.c["outline1 cc"]*Math.sqrt(lp.size));
 for(var i=initialcount;i<circlecount;i++)
 {
  var base=circles[Math.max(lp.r.si(0,circles.length-1),lp.r.si(0,circles.length-1))];
  var ncr=lp.r.sd(1,csrlimit);
  var pr=lp.r.sd(Math.max(0,base.r-ncr),base.r);
  var pa=lp.r.sd(0,pi2);
  if(pa>pi && lp.r.sb(lp.f.c["outline1 frontbias"]==null?lp.f.c["outline1 frontbias"]=lp.f.r.hd(0.5,1.5,"outline1 frontbias"):lp.f.c["outline1 frontbias"]))
  {
   var pa=lp.r.sd(0,pi);
  }
  var lv=[base.v[0]+(Math.cos(pa)*pr),base.v[1]+(Math.sin(pa)*pr)];
  ncr=Math.min(ncr,lv[0]-csedge);
  ncr=Math.min(ncr,(lp.w-csedge)-lv[0]);
  ncr=Math.min(ncr,lv[1]-csedge);
  ncr=Math.min(ncr,(lp.h-csedge)-lv[1]);
  circles.push({"v":lv,"r":ncr});
 }
 lp.csx.fillStyle="#FFFFFF";
 for(var i=0;i<circles.length;i++)
 {
  var lc=circles[i];
  lp.csx.beginPath();
  lp.csx.arc(lc.v[0],lc.v[1],lc.r,0,pi2);
  lp.csx.fill();
  lp.csx.beginPath();
  lp.csx.arc(lp.w-lc.v[0],lc.v[1],lc.r,0,pi2);
  lp.csx.fill();
 }
}

outlines[2]=function(lp) //Mess of lines.
{
 var innersize=[lp.w-csedge2,lp.h-csedge2];
 var points=[[lp.hw,(lp.r.sd(0,0.05)*innersize[1])+csedge],[lp.hw,(lp.r.sd(0.95,1)*innersize[1])+csedge]];
 var basefatness=(cgridsize/lp.size)+(lp.f.c["outline2 basefatness"]==null?lp.f.c["outline2 basefatness"]=lp.f.r.hd(0.03,0.1,"outline2 basefatness"):lp.f.c["outline2 basefatness"]);
 var basemessiness=1/basefatness;
 var pointcount=Math.max(3,Math.ceil(basemessiness*lp.r.sd(0.05,0.1)*Math.sqrt(lp.size)));
 lp.csx.lineCap=["round","square"][lp.f.c["outline2 linecap"]==null?lp.f.c["outline2 linecap"]=lp.f.r.hi(0,1,"outline2 linecap"):lp.f.c["outline2 linecap"]];
 lp.csx.strokeStyle="#FFFFFF";
 for(var npi=1;npi<pointcount;npi++)
 {
  var np=points[npi];
  if(np==null)
  {
   np=[(lp.r.sd(0,1)*innersize[0])+csedge,(Math.pow(lp.r.sd(0,1),(lp.f.c["outline2 frontbias"]==null?lp.f.c["outline2 frontbias"]=lp.f.r.hd(0.1,1,"outline2 frontbias"):lp.f.c["outline2 frontbias"]))*innersize[1])+csedge];
   points.push(np);
  }
  var cons=1+lp.r.sseq((lp.f.c["outline2 conadjust"]==null?lp.f.c["outline2 conadjust"]=lp.f.r.hd(0,1,"outline2 conadjust"):lp.f.c["outline2 conadjust"]),3);
  for(var nci=0;nci<cons;nci++)
  {
   var pre=points[lp.r.si(0,points.length-2)];
   lp.csx.lineWidth=lp.r.sd(0.7,1)*basefatness*lp.size;
   lp.csx.beginPath();
   lp.csx.moveTo(pre[0],pre[1]);
   lp.csx.lineTo(np[0],np[1]);
   lp.csx.stroke();
   lp.csx.beginPath();
   lp.csx.moveTo(lp.w-pre[0],pre[1]);
   lp.csx.lineTo(lp.w-np[0],np[1]);
   lp.csx.stroke();
  }
 }
}

//END OUTLINES

//START COMPONENTS

var cms=8; //Base maximum extent of a component from its origin point. Should be at least equal to cgridsize, but no greater than csedge.
if(cms<cgridsize) {console.log("cms is too small, should be at least equal to cgridsize.");}
if(cms>csedge) {console.log("cms is too large, should be no larger than csedge.");}
var cms2=cms*2;

function backness(lp,v)
{
 return (v[1]/lp.h);
}

function frontness(lp,v)
{
 return (1-(v[1]/lp.h));
}

function centerness(lp,v,do_x,do_y)
{
 var rv=1;
 if(do_x)
 {
  rv=Math.min(rv,1-(Math.abs(v[0]-lp.hw)/lp.hw));
 }
 if(do_y)
 {
  rv=Math.min(rv,1-(Math.abs(v[1]-lp.hh)/lp.hh));
 }
 return rv;
}

function bigness(lp,v)
{
 var effect_center=centerness(lp,v,true,true);
 var effect_shipsize=1-(1/(((lp.w+lp.h)/1000)+1));
 var effect_faction=(lp.f.c["master bigness"]==null?lp.f.c["master bigness"]=Math.pow(lp.f.r.hd(0,1,"master bigness"),0.5):lp.f.c["master bigness"]);
 var effect_stack=(1-lp.getpcdone());
 return (effect_center*effect_shipsize*effect_faction*effect_stack);
}

function leeway(lp,bb)
{
 return [Math.min(bb[0][0]-csedge,(lp.w-csedge)-bb[1][0]),Math.min(bb[0][1]-csedge,(lp.h-csedge)-bb[1][1])];
}

function shadowcolor(amount) //amount is the amount of shadow, 0 - 1.
{
 return "rgba(0,0,0,"+clamp(amount,0,1)+")";
}

function shadowgradient(lp,middlep,edgep,amount) //lp is the ship. amount is the amount of shadow at the edges, 0 - 1 (the middle is always 0). middlep and edgep should be vectors at the middle and edge of the gradient.
{
 var grad=lp.cfx.createLinearGradient(edgep[0],edgep[1],(middlep[0]*2)-edgep[0],(middlep[1]*2)-edgep[1]);
 var darkness=shadowcolor(amount);
 grad.addColorStop(0,darkness);
 grad.addColorStop(0.5,"rgba(0,0,0,0)");
 grad.addColorStop(1,darkness);
 return grad;
}

var components=[]; //Each component function takes an argument 'lp' (for the ship) and 'v' (an integral 2-vector denoting the center of the component).

components[0]=function(lp,v) //Bordered block.
{
 var lcms=cms;
 var bn=Math.pow(bigness(lp,v),0.3);
 if(lp.r.sb((lp.f.c["com0 bigchance"]==null?lp.f.c["com0 bigchance"]=lp.f.r.hd(0,0.9,"com0 bigchance"):lp.f.c["com0 bigchance"])*bn))
 {
  while(lp.r.sb((lp.f.c["com0 bigincchance"]==null?lp.f.c["com0 bigincchance"]=lp.f.r.hd(0,0.5,"com0 bigincchance"):lp.f.c["com0 bigincchance"])*bn))
  {
   var lw=leeway(lp,[[v[0]-lcms,v[1]-lcms],[v[0]+lcms,v[1]+lcms]]);
   if(Math.min(lw[0],lw[1])>lcms*0.5)
   {
    lcms*=1.5;
   }
   else
   {
    break;
   }
  }
 }
 var lcms2=lcms*2;
 var dhi=[Math.ceil(lp.r.sd(1,Math.max(2,0.5*lcms))),Math.ceil(lp.r.sd(1,Math.max(2,0.5*lcms)))];
 var borderwidth=Math.min(dhi[0],dhi[1])*lp.r.sd(0.1,1.2);
 var dho=[dhi[0]+(borderwidth*2),dhi[1]+(borderwidth*2)];
 var counts=[Math.ceil(lcms2/dho[0]),Math.ceil(lcms2/dho[1])];
 var trv=[Math.round((counts[0]*dho[0])/2),Math.round((counts[1]*dho[1])/2)];
 var pcdone=lp.getpcdone();
 var basecolor=lp.f.getbasecolor(lp);
 var icolorh=color.tohex(color.scaleby(basecolor,lp.r.sd(0.4,1)));
 var ocolorh=color.tohex(color.scaleby(basecolor,lp.r.sd(0.4,1)));
 lp.cfx.fillStyle="rgba(0,0,0,"+lp.r.sd(0,0.25)+")";
 lp.cfx.fillRect((v[0]-trv[0])-1,(v[1]-trv[1])-1,(dho[0]*counts[0])+2,(dho[1]*counts[1])+2);
 lp.cfx.fillStyle=ocolorh;
 lp.cfx.fillRect(v[0]-trv[0],v[1]-trv[1],dho[0]*counts[0],dho[1]*counts[1]);
 lp.cfx.fillStyle=icolorh;
 for(var x=0;x<counts[0];x++)
 {
  var bx=v[0]+borderwidth+(x*dho[0])-trv[0];
  for(var y=0;y<counts[1];y++)
  {
   var by=v[1]+borderwidth+(y*dho[1])-trv[1];
   lp.cfx.fillRect(bx,by,dhi[0],dhi[1]);
  }
 }
 if(lp.r.sb(clamp(((pcdone*0.6)+0.3)*(lcms/cms),0,0.98)))
 {
  lp.cfx.fillStyle=shadowgradient(lp,v,[v[0]+trv[0],v[1]],lp.r.sd(0,0.9));
  lp.cfx.fillRect(v[0]-trv[0],v[1]-trv[1],dho[0]*counts[0],dho[1]*counts[1]);
 }
}

components[1]=function(lp,v) //Cylinder array
{
 var lcms=cms;
 var bn=Math.pow(bigness(lp,v),0.2);
 if(lp.r.sb((lp.f.c["com1 bigchance"]==null?lp.f.c["com1 bigchance"]=lp.f.r.hd(0.3,1,"com1 bigchance"):lp.f.c["com1 bigchance"])*bn))
 {
  while(lp.r.sb((lp.f.c["com1 bigincchance"]==null?lp.f.c["com1 bigincchance"]=lp.f.r.hd(0,0.6,"com1 bigincchance"):lp.f.c["com1 bigincchance"])*bn))
  {
   var lw=leeway(lp,[[v[0]-lcms,v[1]-lcms],[v[0]+lcms,v[1]+lcms]]);
   if(Math.min(lw[0],lw[1])>lcms*0.5)
   {
    lcms*=1.5;
   }
   else
   {
    break;
   }
  }
 }
 var w=Math.ceil(lp.r.sd(0.8,2)*lcms);
 var h=Math.ceil(lp.r.sd(0.8,2)*lcms);
 var cw=lp.r.si(3,Math.max(4,w));
 var count=Math.max(1,Math.round(w/cw));
 w=count*cw;
 var basecolor=lp.f.getbasecolor(lp);
 var ccolor=color.tohex(color.scaleby(basecolor,lp.r.sd(0.5,1)));
 var darkness=lp.r.sd(0.3,0.9);
 var orientation=lp.r.sb(lp.f.c["com1 hchance"]==null?lp.f.c["com1 hchance"]=clamp(lp.f.r.hd(-0.2,1.2,"com1 hchance"),0,1):lp.f.c["com1 hchance"]); //true = horizontal array, false = vertical array.
 if(orientation)
 {
  var bv=[v[0]-Math.floor(w/2),v[1]-Math.floor(h/2)];
  lp.cfx.fillStyle="rgba(0,0,0,"+lp.r.sd(0,0.25)+")";
  lp.cfx.fillRect(bv[0]-1,bv[1]-1,w+2,h+2);
  lp.cfx.fillStyle=ccolor;
  lp.cfx.fillRect(bv[0],bv[1],w,h);
  for(var i=0;i<count;i++)
  {
   lp.cfx.fillStyle=shadowgradient(lp,[bv[0]+((i+0.5)*cw),v[1]],[bv[0]+(i*cw),v[1]],darkness);
   lp.cfx.fillRect(bv[0]+(i*cw),bv[1],cw,h);
  }
 }
 else
 {
  var bv=[v[0]-Math.floor(h/2),v[1]-Math.floor(w/2)];
  lp.cfx.fillStyle="rgba(0,0,0,"+lp.r.sd(0,0.25)+")";
  lp.cfx.fillRect(bv[0]-1,bv[1]-1,h+2,w+2);
  lp.cfx.fillStyle=ccolor;
  lp.cfx.fillRect(bv[0],bv[1],h,w);
  for(var i=0;i<count;i++)
  {
   lp.cfx.fillStyle=shadowgradient(lp,[v[0],bv[1]+((i+0.5)*cw)],[v[0],bv[1]+(i*cw)],darkness);
   lp.cfx.fillRect(bv[0],bv[1]+(i*cw),w,cw);
  }
 }
}

components[2]=function(lp,v) //Banded cylinder
{
 var lcms=cms;
 var bn=Math.pow(bigness(lp,v),0.05);
 if(lp.r.sb((lp.f.c["com2 bigchance"]==null?lp.f.c["com2 bigchance"]=lp.f.r.hd(0,1,"com2 bigchance"):lp.f.c["com2 bigchance"])*bn))
 {
  while(lp.r.sb((lp.f.c["com2 bigincchance"]==null?lp.f.c["com2 bigincchance"]=lp.f.r.hd(0,0.9,"com2 bigincchance"):lp.f.c["com2 bigincchance"])*bn))
  {
   var lw=leeway(lp,[[v[0]-lcms,v[1]-lcms],[v[0]+lcms,v[1]+lcms]]);
   if(Math.min(lw[0],lw[1])>lcms*0.5)
   {
    lcms*=1.5;
   }
   else
   {
    break;
   }
  }
 }
 var w=Math.ceil(lp.r.sd(0.6,1.4)*lcms);
 var h=Math.ceil(lp.r.sd(1,2)*lcms);
 var wh2=[Math.ceil(clamp(w*lp.r.sd(0.7,1)/2,1,w)),Math.ceil(clamp(w*lp.r.sd(0.8,1)/2,1,w))];
 var h2=[Math.floor(clamp(w*lp.r.sd(0.05,0.25),1,h)),Math.floor(clamp(w*lp.r.sd(0.1,0.3),1,h))];
 var hpair=h2[0]+h2[1];
 var odd=lp.r.sb(lp.f.c["com2 oddchance"]==null?lp.f.c["com2 oddchance"]=Math.pow(lp.f.r.hd(0,1,"com2 oddchance"),0.5):lp.f.c["com2 oddchance"]);
 var count=clamp(Math.floor(h/hpair),1,h);
 var htotal=(count*hpair)+(odd?h2[0]:0);
 var basecolor=lp.f.getbasecolor(lp);
 var color2=[color.scaleby(basecolor,lp.r.sd(0.6,1)),color.scaleby(basecolor,lp.r.sd(0.6,1))];
 var darkness=lp.r.sd(0.5,0.95);
 var lightness=1-darkness;
 var colord2=[color.scaleby(color2[0],lightness),color.scaleby(color2[1],lightness)];
 var orientation=lp.r.sb(lp.f.c["com2 verticalchance"]==null?lp.f.c["com2 verticalchance"]=Math.pow(lp.f.r.hd(0,1,"com2 verticalchance"),0.1):lp.f.c["com2 verticalchance"]);
 if(orientation)
 {
  var grad2=[lp.cfx.createLinearGradient(v[0]-wh2[0],v[1],v[0]+wh2[0],v[1]),lp.cfx.createLinearGradient(v[0]-wh2[1],v[1],v[0]+wh2[1],v[1])];
  grad2[0].addColorStop(0,color.tohex(colord2[0]));
  grad2[0].addColorStop(0.5,color.tohex(color2[0]));
  grad2[0].addColorStop(1,color.tohex(colord2[0]));
  grad2[1].addColorStop(0,color.tohex(colord2[1]));
  grad2[1].addColorStop(0.5,color.tohex(color2[1]));
  grad2[1].addColorStop(1,color.tohex(colord2[1]));
  var by=Math.floor(v[1]-htotal/2);
  for(var i=0;i<count;i++)
  {
   lp.cfx.fillStyle=grad2[0];
   lp.cfx.fillRect(v[0]-wh2[0],by+(i*hpair),wh2[0]*2,h2[0]);
   lp.cfx.fillStyle=grad2[1];
   lp.cfx.fillRect(v[0]-wh2[1],by+(i*hpair)+h2[0],wh2[1]*2,h2[1]);
  }
  if(odd)
  {
   lp.cfx.fillStyle=grad2[0];
   lp.cfx.fillRect(v[0]-wh2[0],by+(count*hpair),wh2[0]*2,h2[0]);
  }
 }
 else
 {
  var grad2=[lp.cfx.createLinearGradient(v[0],v[1]-wh2[0],v[0],v[1]+wh2[0]),lp.cfx.createLinearGradient(v[0],v[1]-wh2[1],v[0],v[1]+wh2[1])];
  grad2[0].addColorStop(0,color.tohex(colord2[0]));
  grad2[0].addColorStop(0.5,color.tohex(color2[0]));
  grad2[0].addColorStop(1,color.tohex(colord2[0]));
  grad2[1].addColorStop(0,color.tohex(colord2[1]));
  grad2[1].addColorStop(0.5,color.tohex(color2[1]));
  grad2[1].addColorStop(1,color.tohex(colord2[1]));
  var bx=Math.floor(v[0]-htotal/2);
  for(var i=0;i<count;i++)
  {
   lp.cfx.fillStyle=grad2[0];
   lp.cfx.fillRect(bx+(i*hpair),v[1]-wh2[0],h2[0],wh2[0]*2);
   lp.cfx.fillStyle=grad2[1];
   lp.cfx.fillRect(bx+(i*hpair)+h2[0],v[1]-wh2[1],h2[1],wh2[1]*2);
  }
  if(odd)
  {
   lp.cfx.fillStyle=grad2[0];
   lp.cfx.fillRect(bx+(count*hpair),v[1]-wh2[0],h2[0],wh2[0]*2);
  }
 }
}

components[3]=function(lp,v) //Rocket engine (or tries to call another random component if too far forward)
{
 if(lp.r.sb(frontness(lp,v)-0.3) || lp.getcellstate(v[0],v[1]+(cgridsize*1.2))>0 || lp.getcellstate(v[0],v[1]+(cgridsize*1.8))>0)
 {
  for(var tries=0;tries<100;tries++)
  {
   var which=lp.r.schoose(lp.f.cchances);
   if(which!=3)
   {
    components[which](lp,v);
    return;
   }
  }
 }
 var lcms=cms;
 var bn=Math.pow(bigness(lp,v),0.1);
 if(lp.r.sb((lp.f.c["com3 bigchance"]==null?lp.f.c["com3 bigchance"]=lp.f.r.hd(0.6,1,"com3 bigchance"):lp.f.c["com3 bigchance"])*bn))
 {
  while(lp.r.sb((lp.f.c["com3 bigincchance"]==null?lp.f.c["com3 bigincchance"]=lp.f.r.hd(0.3,0.8,"com3 bigincchance"):lp.f.c["com3 bigincchance"])*bn))
  {
   var lw=leeway(lp,[[v[0]-lcms,v[1]-lcms],[v[0]+lcms,v[1]+lcms]]);
   if(Math.min(lw[0],lw[1])>lcms*0.5)
   {
    lcms*=1.5;
   }
   else
   {
    break;
   }
  }
 }
 var w=lp.r.sd(1,2)*lcms;
 var h=Math.ceil(lp.r.sd(0.3,1)*lcms);
 var nratio=lp.r.sd(0.25,0.6);
 var nw=w*nratio;
 var midw=(w+nw)/2;
 var midwh=midw/2;
 var h2=[Math.max(1,Math.ceil(h*lp.r.sd(0.08,0.25))),Math.max(1,Math.ceil(h*lp.r.sd(0.03,0.15)))];
 var hpair=h2[0]+h2[1];
 var count=Math.ceil(h/hpair);
 h=(count*hpair)+h2[0];
 lp.f.setupcolors();
 var basecolor=lp.f.c["base colors"][lp.f.c["com3 basecolor"]==null?lp.f.c["com3 basecolor"]=lp.f.r.hchoose(lp.f.c["base color chances"],"com3 basecolor"):lp.f.c["com3 basecolor"]];
 var lightness0_mid=(lp.f.c["com3 lightness0 mid"]==null?lp.f.c["com3 lightness0 mid"]=lp.f.r.hd(0.5,0.8,"com3 lightness0 mid"):lp.f.c["com3 lightness0 mid"]);
 var lightness0_edge=lightness0_mid-(lp.f.c["com3 lightness0 edge"]==null?lp.f.c["com3 lightness0 edge"]=lp.f.r.hd(0.2,0.4,"com3 lightness0 edge"):lp.f.c["com3 lightness0 edge"]);
 var lightness1_edge=(lp.f.c["com3 lightness1 edge"]==null?lp.f.c["com3 lightness1 edge"]=lp.f.r.hd(0,0.2,"com3 lightness1 edge"):lp.f.c["com3 lightness1 edge"]);
 var grad2=[lp.cfx.createLinearGradient(v[0]-midwh,v[1],v[0]+midwh,v[1]),lp.cfx.createLinearGradient(v[0]-midwh,v[1],v[0]+midwh,v[1])];
 grad2[0].addColorStop(0,color.tohex(color.scaleby(basecolor,lightness0_edge)));
 grad2[0].addColorStop(0.5,color.tohex(color.scaleby(basecolor,lightness0_mid)));
 grad2[0].addColorStop(1,color.tohex(color.scaleby(basecolor,lightness0_edge)));
 grad2[1].addColorStop(0,color.tohex(color.scaleby(basecolor,lightness1_edge)));
 grad2[1].addColorStop(0.5,color.tohex(basecolor));
 grad2[1].addColorStop(1,color.tohex(color.scaleby(basecolor,lightness1_edge)));
 var by=Math.ceil(v[1]-(h/2));
 lp.cfx.fillStyle=grad2[0];
 lp.cfx.beginPath();
 lp.cfx.moveTo(v[0]-(nw/2),by);
 lp.cfx.lineTo(v[0]+(nw/2),by);
 lp.cfx.lineTo(v[0]+(w/2),by+h);
 lp.cfx.lineTo(v[0]-(w/2),by+h);
 lp.cfx.fill();
 lp.cfx.fillStyle=grad2[1];
 var byh=[by+h2[0],by+hpair];
 for(var i=0;i<count;i++)
 {
  var lyr=[(i*hpair)+h2[0],(i+1)*hpair];
  var ly=[byh[0]+(i*hpair),byh[1]+(i*hpair)];
  var lw=[(nw+((w-nw)*(lyr[0]/h)))/2,(nw+((w-nw)*(lyr[1]/h)))/2];
  lp.cfx.beginPath();
  lp.cfx.moveTo(v[0]-lw[0],ly[0]);
  lp.cfx.lineTo(v[0]+lw[0],ly[0]);
  lp.cfx.lineTo(v[0]+lw[1],ly[1]);
  lp.cfx.lineTo(v[0]-lw[1],ly[1]);
  lp.cfx.fill();
 }
}

components[4]=function(lp,v) //Elongated cylinder (calls component 0 - 2 on top of its starting point)
{
 var cn=centerness(lp,v,true,false);
 var lightmid=lp.r.sd(0.7,1);
 var lightedge=lp.r.sd(0,0.2);
 var basecolor=lp.f.getbasecolor(lp);
 var colormid=color.tohex(color.scaleby(basecolor,lightmid));
 var coloredge=color.tohex(color.scaleby(basecolor,lightedge));
 if(lp.f.c["com4 directionc"]==null)
 {
  lp.f.c["com4 directionc"]=[
    1*Math.pow(lp.f.r.hd(0,1,"com4 directionc0"),4), //forwards
    0.1*Math.pow(lp.f.r.hd(0,1),4,"com4 directionc1"), //backwards
    0.2*Math.pow(lp.f.r.hd(0,1),4,"com4 directionc2") //to center
   ];
 }
 var w=Math.max(3,Math.ceil(lp.size*Math.pow(lp.r.sd(0.4,1),2)*(lp.f.c["com4 maxwidth"]==null?lp.f.c["com4 maxwidth"]=lp.f.r.hd(0.02,0.1,"com4 maxwidth"):lp.f.c["com4 maxwidth"])));
 var hwi=Math.floor(w/2);
 var hwe=w%2;
 var direction=lp.r.schoose([lp.f.c["com4 directionc"][0]*(2-cn),lp.f.c["com4 directionc"][1],lp.f.c["com4 directionc"][2]*(1+cn)]);
 var ev=null;
 if(direction==0) //forwards
 {
  var hlimit=v[1]-csedge;
  var h=Math.min(Math.max(cms,hlimit-lp.r.si(0,cms*2)),Math.floor(0.7*lp.size*Math.pow(lp.r.sd(0,1),(lp.f.c["com4 hpower0"]==null?lp.f.c["com4 hpower0"]=lp.f.r.hd(2,6,"com4 hpower0"):lp.f.c["com4 hpower0"]))));
  var bb=[[v[0]-hwi,v[1]-h],[v[0]+hwi+hwe,v[1]]];
  var grad=lp.cfx.createLinearGradient(bb[0][0],bb[0][1],bb[1][0],bb[0][1]);
  grad.addColorStop(0,coloredge);
  grad.addColorStop(0.5,colormid);
  grad.addColorStop(1,coloredge);
  lp.cfx.fillStyle=grad;
  lp.cfx.fillRect(bb[0][0],bb[0][1],w,h);
  ev=[v[0],v[1]-h];
 }
 else if(direction==1) //backwards
 {
  var hlimit=lp.h-(csedge+v[1]);
  var h=Math.min(Math.max(cms,hlimit-lp.r.si(0,cms*2)),Math.floor(0.6*lp.size*Math.pow(lp.r.sd(0,1),(lp.f.c["com4 hpower1"]==null?lp.f.c["com4 hpower1"]=lp.f.r.hd(2,7,"com4 hpower1"):lp.f.c["com4 hpower1"]))));
  var bb=[[v[0]-hwi,v[1]],[v[0]+hwi+hwe,v[1]+h]];
  var grad=lp.cfx.createLinearGradient(bb[0][0],bb[0][1],bb[1][0],bb[0][1]);
  grad.addColorStop(0,coloredge);
  grad.addColorStop(0.5,colormid);
  grad.addColorStop(1,coloredge);
  lp.cfx.fillStyle=grad;
  lp.cfx.fillRect(bb[0][0],bb[0][1],w,h);
  ev=[v[0],v[1]+h];
 }
 else if(direction==2) //to center
 {
  var grad=lp.cfx.createLinearGradient(v[0],v[1]-hwi,v[0],v[1]+hwi+hwe);
  grad.addColorStop(0,coloredge);
  grad.addColorStop(0.5,colormid);
  grad.addColorStop(1,coloredge);
  lp.cfx.fillStyle=grad;
  lp.cfx.fillRect(v[0],v[1]-hwi,Math.ceil(lp.hw-v[0])+1,w);
  ev=[Math.floor(lp.hw),v[1]+h];
 }
 if(lp.f.c["com4 covercomc"]==null)
 {
  lp.f.c["com4 covercomc"]=[
    0.6*Math.pow(lp.f.r.hd(0,1,"com4 covercomc0"),2),
    0.2*Math.pow(lp.f.r.hd(0,1,"com4 covercomc1"),2),
    1*Math.pow(lp.f.r.hd(0,1,"com4 covercomc2"),2)
   ];
 }
 components[lp.r.schoose(lp.f.c["com4 covercomc"])](lp,v);
 if(lp.getcellstate(ev[0],ev[1])>0)
 {
  var nev=[ev[0]+Math.round(lp.r.sd(-1,1)*cgridsize),ev[1]+Math.round(lp.r.sd(-1,1)*cgridsize)];
  if(lp.getcellstate(nev[0],nev[1])>0)
  {
   components[lp.r.schoose(lp.f.c["com4 covercomc"])](lp,nev);
  }
  else
  {
   components[lp.r.schoose(lp.f.c["com4 covercomc"])](lp,ev);
  }
 }
}

components[5]=function(lp,v) //Ball
{
 var lcms=cms;
 var bn=Math.pow(bigness(lp,v),0.1);
 if(lp.r.sb((lp.f.c["com5 bigchance"]==null?lp.f.c["com5 bigchance"]=lp.f.r.hd(0,0.9,"com5 bigchance"):lp.f.c["com5 bigchance"])*bn))
 {
  while(lp.r.sb((lp.f.c["com5 bigincchance"]==null?lp.f.c["com5 bigincchance"]=lp.f.r.hd(0,0.8,"com5 bigincchance"):lp.f.c["com5 bigincchance"])*bn))
  {
   var lw=leeway(lp,[[v[0]-lcms,v[1]-lcms],[v[0]+lcms,v[1]+lcms]]);
   if(Math.min(lw[0],lw[1])>lcms*0.5)
   {
    lcms*=1.5;
   }
   else
   {
    break;
   }
  }
 }
 var lightmid=lp.r.sd(0.75,1);
 var lightedge=lp.r.sd(0,0.25);
 var basecolor=lp.f.getbasecolor(lp);
 var colormid=color.tohex(color.scaleby(basecolor,lightmid));
 var coloredge=color.tohex(color.scaleby(basecolor,lightedge));
 var countx=1+lp.r.sseq((lp.f.c["com5 multxc"]==null?lp.f.c["com5 multxc"]=lp.f.r.hd(0,1,"com5 multxc"):lp.f.c["com5 multxc"]),Math.floor(1.2*Math.pow(lcms/cms,0.6)));
 var county=1+lp.r.sseq((lp.f.c["com5 multyc"]==null?lp.f.c["com5 multyc"]=lp.f.r.hd(0,1,"com5 multyc"):lp.f.c["com5 multyc"]),Math.floor(1.2*Math.pow(lcms/cms,0.6)));
 var smallr=(lp.r.sd(0.5,1)*lcms)/Math.max(countx,county);
 var drawr=smallr+0.5;
 var shadowr=smallr+1;
 var centerr=smallr*0.2;
 var hw=smallr*countx;
 var hh=smallr*county;
 var bv=[v[0]-hw,v[1]-hh];
 lp.cfx.fillStyle="rgba(0,0,0,"+lp.r.sd(0,0.2)+")";
 for(var ax=0;ax<countx;ax++)
 {
  var px=bv[0]+(((ax*2)+1)*smallr);
  for(var ay=0;ay<county;ay++)
  {
   var py=bv[1]+(((ay*2)+1)*smallr);
   lp.cfx.beginPath();
   lp.cfx.arc(px,py,shadowr,0,pi2);
   lp.cfx.fill();
  }
 }
 for(var ax=0;ax<countx;ax++)
 {
  var px=bv[0]+(((ax*2)+1)*smallr);
  for(var ay=0;ay<county;ay++)
  {
   var py=bv[1]+(((ay*2)+1)*smallr);
   var grad=lp.cfx.createRadialGradient(px,py,centerr,px,py,drawr);
   grad.addColorStop(0,colormid);
   grad.addColorStop(1,coloredge);
   lp.cfx.fillStyle=grad;
   lp.cfx.beginPath();
   lp.cfx.arc(px,py,drawr,0,pi2);
   lp.cfx.fill();
  }
 }
}

components[6]=function(lp,v) //Forward-facing trapezoidal fin
{
 if(lp.nextpass<=0 || lp.r.sb(frontness(lp,v)))
 {
  components[lp.r.schoose(copyarray(lp.f.cchances,0,5))](lp,v);
  return;
 }
 var lcms=cms;
 var bn=Math.pow(bigness(lp,v),0.05);
 if(lp.r.sb((lp.f.c["com6 bigchance"]==null?lp.f.c["com6 bigchance"]=lp.f.r.hd(0,0.9,"com6 bigchance"):lp.f.c["com6 bigchance"])*bn))
 {
  while(lp.r.sb((lp.f.c["com6 bigincchance"]==null?lp.f.c["com6 bigincchance"]=lp.f.r.hd(0,0.8,"com6 bigincchance"):lp.f.c["com6 bigincchance"])*bn))
  {
   var lw=leeway(lp,[[v[0]-lcms,v[1]-lcms],[v[0]+lcms,v[1]+lcms]]);
   if(Math.min(lw[0],lw[1])>lcms*0.5)
   {
    lcms*=1.5;
   }
   else
   {
    break;
   }
  }
 }
 var h0=Math.ceil(lcms*2*lp.r.sd(0.6,1)); //Inner height, longer.
 var hh0i=Math.floor(h0/2);
 var hh0e=h0%2;
 var h1=h0*Math.pow(lp.r.sd((lp.f.c["com6 h1min"]==null?lp.f.c["com6 h1min"]=Math.pow(lp.f.r.hd(0,0.8,"com6 h1min"),0.5):lp.f.c["com6 h1min"]),0.9),(lp.f.c["com6 h1power"]==null?lp.f.c["com6 h1power"]=lp.f.r.hd(0.5,1.5,"com6 h1power"):lp.f.c["com6 h1power"])); //Outer height, shorter.
 var hh1i=Math.floor(h1/2);
 var hh1e=h0%2;
 var backamount=Math.max(0-((h0-h1)/2),h0*(lp.r.sd(0,0.45)+lp.r.sd(0,0.45))*(lp.f.c["com6 backness"]==null?lp.f.c["com6 backness"]=(lp.f.r.hb(0.8,"com6 backnesstype")?lp.f.r.hd(0.2,0.9,"com6 backness#pos"):lp.f.r.hd(-0.2,-0.05,"com6 backness#neg")):lp.f.c["com6 backness"]));
 var w=Math.ceil(lcms*lp.r.sd(0.7,1)*(lp.f.c["com6 width"]==null?lp.f.c["com6 width"]=Math.pow(lp.f.r.hd(0.1,3.5,"com6 width"),0.5):lp.f.c["com6 width"]));
 var hwi=Math.floor(w/2);
 var hwe=w%2;
 var quad=[[v[0]-hwi,v[1]+backamount-hh1i],[v[0]+hwi+hwe,v[1]-hh0i],[v[0]+hwi+hwe,v[1]+hh0i+hh0e],[v[0]-hwi,v[1]+backamount+hh1i+hh1e]];
 var basecolor=lp.f.getbasecolor(lp);
 lp.cfx.fillStyle="rgba(0,0,0,"+lp.r.sd(0,0.2)+")";
 lp.cfx.beginPath();
 lp.cfx.moveTo(quad[0][0]-1,quad[0][1]);
 lp.cfx.lineTo(quad[1][0]-1,quad[1][1]);
 lp.cfx.lineTo(quad[2][0]-1,quad[2][1]);
 lp.cfx.lineTo(quad[3][0]-1,quad[3][1]);
 lp.cfx.fill();
 lp.cfx.fillStyle=color.tohex(color.scaleby(basecolor,lp.r.sd(0.7,1)));
 lp.cfx.beginPath();
 lp.cfx.moveTo(quad[0][0],quad[0][1]);
 lp.cfx.lineTo(quad[1][0],quad[1][1]);
 lp.cfx.lineTo(quad[2][0],quad[2][1]);
 lp.cfx.lineTo(quad[3][0],quad[3][1]);
 lp.cfx.fill();
}

components["cabin !UNUSED"]=function(lp,v) //Cabin
{
 if(lp.nextpass<=0 || lp.r.sb(backness(lp,v)))
 {
  components[lp.r.schoose(copyarray(lp.f.cchances,0,5))](lp,v);
  return;
 }
 var lcms=cms;
 var bn=Math.pow(bigness(lp,v),0.1);
 if(lp.r.sb((lp.f.c["com7 bigchance"]==null?lp.f.c["com7 bigchance"]=lp.f.r.hd(0,0.9,"com7 bigchance"):lp.f.c["com7 bigchance"])*bn))
 {
  while(lp.r.sb((lp.f.c["com7 bigincchance"]==null?lp.f.c["com7 bigincchance"]=lp.f.r.hd(0,0.9,"com7 bigincchance"):lp.f.c["com7 bigincchance"])*bn))
  {
   var lw=leeway(lp,[[v[0]-lcms,v[1]-lcms],[v[0]+lcms,v[1]+lcms]]);
   if(Math.min(lw[0],lw[1])>lcms*0.5)
   {
    lcms*=1.5;
   }
   else
   {
    break;
   }
  }
 }
 var h=lcms*lp.r.sd(1,2)*(lp.f.c["com7 height"]==null?lp.f.c["com7 height"]=lp.f.r.hd(0.5,1,"com7 height"):lp.f.c["com7 height"]);
 var hh=h/2;
 var w=1+(h*(lp.f.c["com7 width"]==null?lp.f.c["com7 width"]=lp.f.r.hd(0.3,0.8,"com7 width"):lp.f.c["com7 width"]));
 var hw=w/2;
 var windowcolor=lp.f.getwindowcolor(lp);
 var lightness0=lp.r.sd(0.7,0.9);
 var lightness1=lp.r.sd(0.4,0.6);
 var color0=color.scaleby(windowcolor,lightness0);
 var color1=color.scaleby(windowcolor,lightness1);
 var transparency=(lp.f.c["com7 transparency"]==null?lp.f.c["com7 transparency"]=lp.f.r.hd(0.3,0.5,"com7 transparency"):lp.f.c["com7 transparency"]);
 var grad=lp.cfx.createRadialGradient(0,0,w/20,0,0,w/2);
 grad.addColorStop(0,"rgba(255,255,255,1)");
 grad.addColorStop(0.3,(("rgba("+clamp(Math.round(color0[0]*255),0,255))+(","+clamp(Math.round(color0[1]*255),0,255)))+((","+clamp(Math.round(color0[2]*255),0,255))+(","+(1-transparency)+")")));
 grad.addColorStop(1,(("rgba("+clamp(Math.round(color1[0]*255),0,255))+(","+clamp(Math.round(color1[1]*255),0,255)))+((","+clamp(Math.round(color1[2]*255),0,255))+(","+(1-(transparency/2))+")")));
 lp.cfx.setTransform(1,0,0,h/w,v[0],v[1]);
 lp.cfx.fillStyle=grad;
 lp.cfx.beginPath();
 lp.cfx.arc(0,0,w/2,0,pi2);
 lp.cfx.fill();
 lp.cfx.setTransform(1,0,0,1,0,0);
}

//END COMPONENTS

//START TEXT GENERATION

ship.prototype.generatetext=function()
{
 this.r=new randomizer(this.s+"~");
 this.size2=this.size*this.size; //Estimate of the 2D size of the ship. Roughly 250 - 120K (for ship sizes 15.625 - 343).
 this.size3=this.size*this.size*this.size; //Estimate of the 3D size of the ship. Roughly 4K - 40M (for ship sizes 15.625 - 343).
 this.c["militariness"]=Math.pow(this.r.sd(0,1),0.2)*(this.f.c["militariness"]==null?this.f.c["militariness"]=Math.pow(this.f.r.hd(0,1,"militariness"),0.2):this.f.c["militariness"]);
 this.t_type=text_shiptype(this);
 this.t_name="<h1>"+this.f.name+" "+this.t_type+"</h1>";
 this.t_crew=text_crew(this);
 this.t_power=text_power(this);
 this.t_drive=text_drive(this);
 this.t_defense=text_defense(this);
 this.t_weapons=text_weapons(this);
 this.t_equipment=text_equipment(this);
 this.text=(this.t_name+"<br>")+("<span style='color:#ffccdd;'>"+this.t_crew+"</span><br>")+("<span style='color:#eeee99;'>"+this.t_power+"</span><br>")+("<span style='color:#bbccff;'>"+this.t_drive+"</span><br>")+(this.t_defense+"<br>")+("<span style='color:#ffbb99;'>"+this.t_weapons+"</span><br>")+("<span style='color:#99eebb;'>"+this.t_equipment+"</span><br>");
}

function text_shiptype(lp)
{
 var shiptypes=[];
 var shiptypec=[];
 var shiptypem=[];
 shiptypes.push("freighter"); shiptypem.push(0.05); shiptypec.push((1-lp.c["militariness"])*1*lp.f.r.hd(0.1,1,"shiptype c"+shiptypes[shiptypes.length-1]));
 shiptypes.push("light freighter"); shiptypem.push(0.05); shiptypec.push((1-lp.c["militariness"])*1*clamp(1-(Math.abs(lp.size-20)/30),0,1)*lp.f.r.hd(0.1,1,"shiptype c"+shiptypes[shiptypes.length-1]));
 shiptypes.push("small freighter"); shiptypem.push(0.05); shiptypec.push((1-lp.c["militariness"])*1*clamp(1-(Math.abs(lp.size-20)/40),0,1)*lp.f.r.hd(0.1,1,"shiptype c"+shiptypes[shiptypes.length-1]));
 shiptypes.push("large freighter"); shiptypem.push(0.05); shiptypec.push((1-lp.c["militariness"])*1*clamp(1-(Math.abs(lp.size-250)/120),0,1)*lp.f.r.hd(0.1,1,"shiptype c"+shiptypes[shiptypes.length-1]));
 shiptypes.push("bulk freighter"); shiptypem.push(0.05); shiptypec.push((1-lp.c["militariness"])*1*clamp(1-(Math.abs(lp.size-300)/150),0,1)*lp.f.r.hd(0.1,1,"shiptype c"+shiptypes[shiptypes.length-1]));
 shiptypes.push("space taxi"); shiptypem.push(0.1); shiptypec.push((1-lp.c["militariness"])*0.7*clamp(1-(Math.abs(lp.size-20)/20),0,1)*lp.f.r.hd(0.1,1,"shiptype c"+shiptypes[shiptypes.length-1]));
 shiptypes.push("ferry"); shiptypem.push(0.05); shiptypec.push((1-lp.c["militariness"])*1*clamp(1-(Math.abs(lp.size-60)/80),0,1)*lp.f.r.hd(0.1,1,"shiptype c"+shiptypes[shiptypes.length-1]));
 shiptypes.push("liner"); shiptypem.push(0.05); shiptypec.push((1-lp.c["militariness"])*1*clamp(1-(Math.abs(lp.size-150)/80),0,1)*lp.f.r.hd(0.1,1,"shiptype c"+shiptypes[shiptypes.length-1]));
 shiptypes.push("luxury liner"); shiptypem.push(0.05); shiptypec.push((1-lp.c["militariness"])*0.5*clamp(1-(Math.abs(lp.size-250)/150),0,1)*lp.f.r.hd(0.1,1,"shiptype c"+shiptypes[shiptypes.length-1]));
 shiptypes.push("mining ship"); shiptypem.push(0.2); shiptypec.push((1-lp.c["militariness"])*0.7*clamp(1-(Math.abs(lp.size-30)/400),0,1)*lp.f.r.hd(0.1,1,"shiptype c"+shiptypes[shiptypes.length-1]));
 shiptypes.push("salvage ship"); shiptypem.push(0.3); shiptypec.push((1-lp.c["militariness"])*0.2*clamp(1-(Math.abs(lp.size-150)/300),0,1)*lp.f.r.hd(0.1,1,"shiptype c"+shiptypes[shiptypes.length-1]));
 shiptypes.push("factory ship"); shiptypem.push(0.1); shiptypec.push((1-lp.c["militariness"])*0.6*clamp(1-(Math.abs(lp.size-300)/200),0,1)*lp.f.r.hd(0.1,1,"shiptype c"+shiptypes[shiptypes.length-1]));
 shiptypes.push("ore freighter"); shiptypem.push(0.05); shiptypec.push((1-lp.c["militariness"])*0.2*lp.f.r.hd(0.1,1,"shiptype c"+shiptypes[shiptypes.length-1]));
 shiptypes.push("industrial ship"); shiptypem.push(0.1); shiptypec.push((1-lp.c["militariness"])*0.4*lp.f.r.hd(0.1,1,"shiptype c"+shiptypes[shiptypes.length-1]));
 shiptypes.push("construction ship"); shiptypem.push(0.05); shiptypec.push((1-lp.c["militariness"])*0.2*lp.f.r.hd(0.1,1,"shiptype c"+shiptypes[shiptypes.length-1]));
 shiptypes.push("tanker"); shiptypem.push(0.05); shiptypec.push((1-lp.c["militariness"])*0.5*lp.f.r.hd(0.1,1,"shiptype c"+shiptypes[shiptypes.length-1]));
 shiptypes.push("colony ship"); shiptypem.push(0.2); shiptypec.push((1-lp.c["militariness"])*0.2*clamp(1-(Math.abs(lp.size-300)/150),0,1)*lp.f.r.hd(0.1,1,"shiptype c"+shiptypes[shiptypes.length-1]));
 shiptypes.push("prison ship"); shiptypem.push(0.3); shiptypec.push(0.02*clamp(1-(Math.abs(lp.size-150)/400),0,1)*lp.f.r.hd(0.1,1,"shiptype c"+shiptypes[shiptypes.length-1]));
 shiptypes.push("research ship"); shiptypem.push(0.3); shiptypec.push((1-lp.c["militariness"])*0.3*clamp(1-(Math.abs(lp.size-60)/350),0,1)*lp.f.r.hd(0.1,1,"shiptype c"+shiptypes[shiptypes.length-1]));
 shiptypes.push("medical ship"); shiptypem.push(0.2); shiptypec.push(0.1*clamp(1-(Math.abs(lp.size-60)/250),0,1)*lp.f.r.hd(0.1,1,"shiptype c"+shiptypes[shiptypes.length-1]));
 shiptypes.push("disaster relief ship"); shiptypem.push(0.2); shiptypec.push(0.03*clamp(1-(Math.abs(lp.size-50)/240),0,1)*lp.f.r.hd(0.1,1,"shiptype c"+shiptypes[shiptypes.length-1]));
 shiptypes.push("space yacht"); shiptypem.push(0.3); shiptypec.push(0.5*clamp(1-(Math.abs(lp.size-30)/200),0,1)*lp.f.r.hd(0.1,1,"shiptype c"+shiptypes[shiptypes.length-1]));
 shiptypes.push("troop transport"); shiptypem.push(0.5); shiptypec.push(0.1*clamp(1-(Math.abs(lp.size-60)/150),0,1)*lp.f.r.hd(0.1,1,"shiptype c"+shiptypes[shiptypes.length-1]));
 shiptypes.push("scoutship"); shiptypem.push(0.5); shiptypec.push(0.5*clamp(1-(Math.abs(lp.size-20)/30),0,1)*lp.f.r.hd(0.1,1,"shiptype c"+shiptypes[shiptypes.length-1]));
 shiptypes.push("patrol ship"); shiptypem.push(0.8); shiptypec.push(lp.c["militariness"]*1*clamp(1-(Math.abs(lp.size-20)/50),0,1)*lp.f.r.hd(0.1,1,"shiptype c"+shiptypes[shiptypes.length-1]));
 shiptypes.push("gunship"); shiptypem.push(1); shiptypec.push(lp.c["militariness"]*1*clamp(1-(Math.abs(lp.size-30)/70),0,1)*lp.f.r.hd(0.1,1,"shiptype c"+shiptypes[shiptypes.length-1]));
 shiptypes.push("corvette"); shiptypem.push(1); shiptypec.push(lp.c["militariness"]*0.2*clamp(1-(Math.abs(lp.size-40)/50),0,1)*lp.f.r.hd(0.1,1,"shiptype c"+shiptypes[shiptypes.length-1]));
 shiptypes.push("destroyer"); shiptypem.push(1); shiptypec.push(lp.c["militariness"]*1*clamp(1-(Math.abs(lp.size-70)/70),0,1)*lp.f.r.hd(0.1,1,"shiptype c"+shiptypes[shiptypes.length-1]));
 shiptypes.push("cruiser"); shiptypem.push(1); shiptypec.push(lp.c["militariness"]*1*clamp(1-(Math.abs(lp.size-150)/80),0,1)*lp.f.r.hd(0.1,1,"shiptype c"+shiptypes[shiptypes.length-1]));
 shiptypes.push("battlecruiser"); shiptypem.push(1); shiptypec.push(lp.c["militariness"]*0.5*clamp(1-(Math.abs(lp.size-200)/90),0,1)*lp.f.r.hd(0.1,1,"shiptype c"+shiptypes[shiptypes.length-1]));
 shiptypes.push("battleship"); shiptypem.push(1); shiptypec.push(lp.c["militariness"]*1*clamp(1-(Math.abs(lp.size-250)/100),0,1)*lp.f.r.hd(0.1,1,"shiptype c"+shiptypes[shiptypes.length-1]));
 shiptypes.push("leviathan"); shiptypem.push(1); shiptypec.push(lp.c["militariness"]*0.6*clamp(1-(Math.abs(lp.size-300)/100),0,1)*lp.f.r.hd(0.1,1,"shiptype c"+shiptypes[shiptypes.length-1]));
 shiptypes.push("dreadnought"); shiptypem.push(1); shiptypec.push(lp.c["militariness"]*1*clamp(1-(Math.abs(lp.size-350)/100),0,1)*lp.f.r.hd(0.1,1,"shiptype c"+shiptypes[shiptypes.length-1]));
 shiptypes.push("capital ship"); shiptypem.push(1); shiptypec.push(lp.c["militariness"]*1*clamp(1-(Math.abs(lp.size-350)/150),0,1)*lp.f.r.hd(0.1,1,"shiptype c"+shiptypes[shiptypes.length-1]));
 shiptypes.push("carrier"); shiptypem.push(0.8); shiptypec.push(lp.c["militariness"]*0.6*clamp(1-(Math.abs(lp.size-250)/150),0,1)*lp.f.r.hd(0.1,1,"shiptype c"+shiptypes[shiptypes.length-1]));
 shiptypes.push("supercarrier"); shiptypem.push(0.8); shiptypec.push(lp.c["militariness"]*1*clamp(1-(Math.abs(lp.size-350)/100),0,1)*lp.f.r.hd(0.1,1,"shiptype c"+shiptypes[shiptypes.length-1]));
 var typeid=lp.r.schoose(shiptypec);
 var typem=shiptypem[typeid];
 if(typem<0.5)
 {
  lp.c["militariness"]=lp.c["militariness"]*typem*2;
 }
 else
 {
  lp.c["militariness"]=1-((1-lp.c["militariness"])*(1-(typem*2)));
 }
 return shiptypes[typeid];
}

function text_crew(lp)
{
 if(lp.r.sb(lp.f.c["crew robotchance"]==null?lp.f.c["crew robotchance"]=Math.pow(lp.f.r.hd(0,1,"crew robotchance"),20):lp.f.c["crew robotchance"]))
 {
  lp.c["crew"]=0;
  return ("<b>Crew: none</b> <i>(all ship systems automated)</i><br>");
 }
 else
 {
  lp.c["crew"]=Math.ceil(lp.r.sd(0.0002,0.0008)*lp.size3*(lp.f.c["crew multiplier"]==null?lp.f.c["crew multiplier"]=lp.f.r.hd(0.1,1,"crew multiplier"):lp.f.c["crew multiplier"])*(1-lp.f.c["crew robotchance"]));
  return ("<b>Crew: "+lp.c["crew"]+"</b><br>");
 }
}

function text_power(lp)
{
 var dpe=6; //Default power faction exponent.
 var powertypes=[];
 var powertypec=[];
 powertypes.push("lithium battery"); powertypec.push(0.3*clamp(1-(Math.abs(lp.size-20)/10),0,1)*Math.pow(lp.f.r.hd(0,1,"powertype c"+powertypes[powertypes.length-1]),dpe));
 powertypes.push("lithium battery array"); powertypec.push(0.3*clamp(1-(Math.abs(lp.size-20)/30),0,1)*Math.pow(lp.f.r.hd(0,1,"powertype c"+powertypes[powertypes.length-1]),dpe));
 powertypes.push("plasma battery"); powertypec.push(0.2*clamp(1-(Math.abs(lp.size-30)/30),0,1)*Math.pow(lp.f.r.hd(0,1,"powertype c"+powertypes[powertypes.length-1]),dpe));
 powertypes.push("plasma battery array"); powertypec.push(0.2*clamp(1-(Math.abs(lp.size-40)/50),0,1)*Math.pow(lp.f.r.hd(0,1,"powertype c"+powertypes[powertypes.length-1]),dpe));
 powertypes.push("solar collector"); powertypec.push(0.6*clamp(1-(Math.abs(lp.size-20)/20),0,1)*Math.pow(lp.f.r.hd(0.1,1,"powertype c"+powertypes[powertypes.length-1]),dpe));
 powertypes.push("solar array"); powertypec.push(0.6*clamp(1-(Math.abs(lp.size-30)/20),0,1)*Math.pow(lp.f.r.hd(0.1,1,"powertype c"+powertypes[powertypes.length-1]),dpe));
 powertypes.push("uranium RTG"); powertypec.push(1*clamp(1-(Math.abs(lp.size-30)/20),0,1)*Math.pow(lp.f.r.hd(0.1,1,"powertype c"+powertypes[powertypes.length-1]),dpe));
 powertypes.push("plutonium RTG"); powertypec.push(1*clamp(1-(Math.abs(lp.size-30)/20),0,1)*Math.pow(lp.f.r.hd(0.1,1,"powertype c"+powertypes[powertypes.length-1]),dpe));
 powertypes.push("uranium fission reactor"); powertypec.push(1*clamp(1-(Math.abs(lp.size-150)/400),0,1)*Math.pow(lp.f.r.hd(0.1,1,"powertype c"+powertypes[powertypes.length-1]),dpe));
 powertypes.push("plutonium fission reactor"); powertypec.push(1*clamp(1-(Math.abs(lp.size-200)/300),0,1)*Math.pow(lp.f.r.hd(0.1,1,"powertype c"+powertypes[powertypes.length-1]),dpe));
 powertypes.push("thorium fission reactor"); powertypec.push(0.8*clamp(1-(Math.abs(lp.size-200)/250),0,1)*Math.pow(lp.f.r.hd(0.1,1,"powertype c"+powertypes[powertypes.length-1]),dpe));
 powertypes.push("hydrogen fusion reactor"); powertypec.push(1*clamp(1-(Math.abs(lp.size-200)/200),0,1)*Math.pow(lp.f.r.hd(0.1,1,"powertype c"+powertypes[powertypes.length-1]),dpe));
 powertypes.push("deuterium fusion reactor"); powertypec.push(0.8*clamp(1-(Math.abs(lp.size-250)/200),0,1)*Math.pow(lp.f.r.hd(0.1,1,"powertype c"+powertypes[powertypes.length-1]),dpe));
 powertypes.push("tritium fusion reactor"); powertypec.push(0.5*clamp(1-(Math.abs(lp.size-250)/200),0,1)*Math.pow(lp.f.r.hd(0.1,1,"powertype c"+powertypes[powertypes.length-1]),dpe));
 powertypes.push("helium-3 fusion reactor"); powertypec.push(0.6*clamp(1-(Math.abs(lp.size-250)/200),0,1)*Math.pow(lp.f.r.hd(0.1,1,"powertype c"+powertypes[powertypes.length-1]),dpe));
 powertypes.push("helium fusion reactor"); powertypec.push(0.4*clamp(1-(Math.abs(lp.size-250)/200),0,1)*Math.pow(lp.f.r.hd(0.1,1,"powertype c"+powertypes[powertypes.length-1]),dpe));
 powertypes.push("lithium fusion reactor"); powertypec.push(0.2*clamp(1-(Math.abs(lp.size-300)/200),0,1)*Math.pow(lp.f.r.hd(0,1,"powertype c"+powertypes[powertypes.length-1]),dpe));
 powertypes.push("antimatter reactor"); powertypec.push(1.6*clamp(1-(Math.abs(lp.size-350)/400),0,1)*Math.pow(lp.f.r.hd(0,1,"powertype c"+powertypes[powertypes.length-1]),dpe));
 powertypes.push("matter converter"); powertypec.push(1.3*clamp(1-(Math.abs(lp.size-350)/400),0,1)*Math.pow(lp.f.r.hd(0,1,"powertype c"+powertypes[powertypes.length-1]),dpe));
 powertypes.push("Casimir device"); powertypec.push(1.1*clamp(1-(Math.abs(lp.size-350)/400),0,1)*Math.pow(lp.f.r.hd(0,1,"powertype c"+powertypes[powertypes.length-1]),dpe));
 powertypes.push("minisolar generator"); powertypec.push(0.1*clamp(1-(Math.abs(lp.size-350)/400),0,1)*Math.pow(lp.f.r.hd(0,1,"powertype c"+powertypes[powertypes.length-1]),dpe));
 powertypes.push("trapped energy being"); powertypec.push(0.0005*clamp(1-(Math.abs(lp.size-100)/400),0,1)*Math.pow(lp.f.r.hd(0,1,"powertype c"+powertypes[powertypes.length-1]),dpe));
 powertypes.push("trapped cosmic entity"); powertypec.push(0.0005*clamp(1-(Math.abs(lp.size-350)/400),0,1)*Math.pow(lp.f.r.hd(0,1,"powertype c"+powertypes[powertypes.length-1]),dpe));
 lp.c["powerlevel"]=100000+(4000*lp.r.sd(0.3,1)*lp.size3*lp.f.r.hd(0.3,1,"power level"));
 var power=Math.floor(lp.c["powerlevel"])+"W";
 if(lp.c["powerlevel"]>=2000000000000)
 {
  power=Math.floor(lp.c["powerlevel"]/1000000000000)+"TW";
 }
 else if(lp.c["powerlevel"]>=2000000000)
 {
  power=Math.floor(lp.c["powerlevel"]/1000000000)+"GW";
 }
 else if(lp.c["powerlevel"]>=2000000)
 {
  power=Math.floor(lp.c["powerlevel"]/1000000)+"MW";
 }
 else if(lp.c["powerlevel"]>=2000)
 {
  power=Math.floor(lp.c["powerlevel"]/1000)+"KW";
 }
 var powertypeid=lp.r.schoose(powertypec);
 var powertype=powertypes[powertypeid];
 return ("<b>Power source:</b> "+(power+" "+powertype)+"<br>");
}

//START DRIVES

var drive_subl=null;
var drive_superl=null;

function setup_drives(lp)
{
 var dsube=6; //Default sublight drive faction exponent.
 drive_subl=[];
 lp.c["drive subl chances"]=[];
 drive_subl.push("hydrogen rocket"); lp.c["drive subl chances"].push(0.5*Math.pow(lp.f.r.hd(0.1,1,"drive subl c"+drive_subl.length),dsube));
 drive_subl.push("kerosene rocket"); lp.c["drive subl chances"].push(0.2*Math.pow(lp.f.r.hd(0,1,"drive subl c"+drive_subl.length),dsube));
 drive_subl.push("hydrazine rocket"); lp.c["drive subl chances"].push(0.2*Math.pow(lp.f.r.hd(0,1,"drive subl c"+drive_subl.length),dsube));
 drive_subl.push("methane rocket"); lp.c["drive subl chances"].push(0.5*Math.pow(lp.f.r.hd(0,1,"drive subl c"+drive_subl.length),dsube));
 drive_subl.push("cryonitrogen rocket"); lp.c["drive subl chances"].push(0.1*Math.pow(lp.f.r.hd(0,1,"drive subl c"+drive_subl.length),dsube));
 drive_subl.push("ion thruster"); lp.c["drive subl chances"].push(1*Math.pow(lp.f.r.hd(0.1,1,"drive subl c"+drive_subl.length),dsube));
 drive_subl.push("nuclear thermal rocket"); lp.c["drive subl chances"].push(0.8*Math.pow(lp.f.r.hd(0.1,1,"drive subl c"+drive_subl.length),dsube));
 drive_subl.push("nuclear pulse rocket"); lp.c["drive subl chances"].push(0.6*Math.pow(lp.f.r.hd(0.1,1,"drive subl c"+drive_subl.length),dsube));
 drive_subl.push("magneto-inertial fusion rocket"); lp.c["drive subl chances"].push(0.3*Math.pow(lp.f.r.hd(0.1,1,"drive subl c"+drive_subl.length),dsube));
 drive_subl.push("fusion rocket"); lp.c["drive subl chances"].push(1*Math.pow(lp.f.r.hd(0.1,1,"drive subl c"+drive_subl.length),dsube));
 drive_subl.push("antimatter rocket"); lp.c["drive subl chances"].push(1*Math.pow(lp.f.r.hd(0.1,1,"drive subl c"+drive_subl.length),dsube));
 drive_subl.push("neutron rocket"); lp.c["drive subl chances"].push(0.05*Math.pow(lp.f.r.hd(0,1,"drive subl c"+drive_subl.length),dsube));
 drive_subl.push("dark matter rocket"); lp.c["drive subl chances"].push(0.3*Math.pow(lp.f.r.hd(0,1,"drive subl c"+drive_subl.length),dsube));
 drive_subl.push("gravity thruster"); lp.c["drive subl chances"].push(0.2*Math.pow(lp.f.r.hd(0,1,"drive subl c"+drive_subl.length),dsube));
 drive_subl.push("dark energy thruster"); lp.c["drive subl chances"].push(0.3*Math.pow(lp.f.r.hd(0,1,"drive subl c"+drive_subl.length),dsube));
 drive_subl.push("reactionless thruster"); lp.c["drive subl chances"].push(2*Math.pow(lp.f.r.hd(0,1,"drive subl c"+drive_subl.length),dsube));
 var dsupe=6; //Default FTL drive faction exponent.
 drive_superl=[];
 lp.c["drive superl chances"]=[];
 drive_superl.push("tachyon drive"); lp.c["drive superl chances"].push(1*Math.pow(lp.f.r.hd(0.1,1,"drive superl c"+drive_superl.length),dsupe));
 drive_superl.push("warp drive"); lp.c["drive superl chances"].push(0.6*Math.pow(lp.f.r.hd(0,1,"drive superl c"+drive_superl.length),dsupe));
 drive_superl.push("Alcubierre drive"); lp.c["drive superl chances"].push(0.8*Math.pow(lp.f.r.hd(0,1,"drive superl c"+drive_superl.length),dsupe));
 drive_superl.push("hyperspace drive"); lp.c["drive superl chances"].push(1*Math.pow(lp.f.r.hd(0.1,1,"drive superl c"+drive_superl.length),dsupe));
 drive_superl.push("subspace drive"); lp.c["drive superl chances"].push(0.2*Math.pow(lp.f.r.hd(0,1,"drive superl c"+drive_superl.length),dsupe));
 drive_superl.push("jump drive"); lp.c["drive superl chances"].push(0.4*Math.pow(lp.f.r.hd(0,1,"drive superl c"+drive_superl.length),dsupe));
 drive_superl.push("displacement drive"); lp.c["drive superl chances"].push(0.2*Math.pow(lp.f.r.hd(0,1,"drive superl c"+drive_superl.length),dsupe));
 drive_superl.push("quantum tunnel drive"); lp.c["drive superl chances"].push(0.2*Math.pow(lp.f.r.hd(0,1,"drive superl c"+drive_superl.length),dsupe));
 drive_superl.push("macrospace teleporter"); lp.c["drive superl chances"].push(0.02*Math.pow(lp.f.r.hd(0,1,"drive superl c"+drive_superl.length),dsupe));
 drive_superl.push("wormhole generator"); lp.c["drive superl chances"].push(0.03*Math.pow(lp.f.r.hd(0,1,"drive superl c"+drive_superl.length),dsupe));
 drive_superl.push("spacetime catapult"); lp.c["drive superl chances"].push(0.01*Math.pow(lp.f.r.hd(0,1,"drive superl c"+drive_superl.length),dsupe));
}

function text_drive(lp)
{
 var rv="<b>Propulsion:</b><br>";
 if(lp.c["drive subl chances"]==null)
 {
  setup_drives(lp);
 }
 var sublchance=1-(1/(((lp.r.sd(0,10)+Math.pow(lp.size,0.8))*0.005)+1));
 var sublcount=1+lp.r.sseq(sublchance,3);
 var subls=[];
 var sublincchance=1-(1/(((lp.r.sd(0,10)+Math.pow(lp.size,0.7))*0.06)+1));
 for(var tries=0;(tries<1000 && subls.length<sublcount);tries++)
 {
  var ndi=lp.r.schoose(lp.c["drive subl chances"]);
  var nd=drive_subl[ndi];
  if(lp.r.sb((sublincchance*0.5)+0.5))
  {
   var multi=2+lp.r.sseq(sublincchance,4+Math.floor(lp.size/10));
   nd=(multi+"x ")+(nd+"s");
  }
  else if(lp.r.sb(Math.pow(lp.size,0.3)/6))
  {
   nd=(lp.r.sb(0.5)?"large ":"heavy ")+nd;
  }
  if(!arraycontains(subls,ndi))
  {
   subls.push(ndi);
   rv=rv+(nd+"<br>");
  }
 }
 if(lp.r.sb(1-(1/((lp.r.sd(0,1)+lp.f.r.hd(0,1,"ftl capability")+Math.pow(lp.size,0.3))-1))+1))
 {
  var nfi=lp.r.schoose(lp.c["drive superl chances"]);
  var nf=drive_superl[nfi];
  lp.c["ftlpower"]=lp.c["powerlevel"]*lp.r.sd(0.4,0.9)*lp.f.r.hd(0.4,0.9,"ftl drive power");
  var power=Math.floor(lp.c["ftlpower"])+"W";
  if(lp.c["ftlpower"]>=2000000000000)
  {
   power=Math.floor(lp.c["ftlpower"]/1000000000000)+"TW";
  }
  else if(lp.c["ftlpower"]>=2000000000)
  {
   power=Math.floor(lp.c["ftlpower"]/1000000000)+"GW";
  }
  else if(lp.c["ftlpower"]>=2000000)
  {
   power=Math.floor(lp.c["ftlpower"]/1000000)+"MW";
  }
  else if(lp.c["ftlpower"]>=2000)
  {
   power=Math.floor(lp.c["ftlpower"]/1000)+"KW";
  }
  rv=rv+((power+" ")+(nf+"<br>"));
 }
 return rv;
}

//END DRIVES

//START DEFENSE

var armor_materials=null;
var armor_matvalues=null;
var armor_constructions=null;
var armor_modifiers=null;

function setup_armor(lp)
{
 var ame=4; //Default armor material faction exponent.
 armor_materials=[];
 armor_matvalues=[];
 lp.c["armor material chances"]=[];
 armor_materials.push("aluminum"); armor_matvalues.push(0.5); lp.c["armor material chances"].push(1*Math.pow(lp.f.r.hd(0.1,1,"armor material c"+armor_materials.length),ame));
 armor_materials.push("steel"); armor_matvalues.push(1); lp.c["armor material chances"].push(1*Math.pow(lp.f.r.hd(0.1,1,"armor material c"+armor_materials.length),ame));
 armor_materials.push("duraluminum"); armor_matvalues.push(0.8); lp.c["armor material chances"].push(0.4*Math.pow(lp.f.r.hd(0,1,"armor material c"+armor_materials.length),ame));
 armor_materials.push("durasteel"); armor_matvalues.push(1.5); lp.c["armor material chances"].push(0.4*Math.pow(lp.f.r.hd(0,1,"armor material c"+armor_materials.length),ame));
 armor_materials.push("carbon fiber"); armor_matvalues.push(1.2); lp.c["armor material chances"].push(0.7*Math.pow(lp.f.r.hd(0,1,"armor material c"+armor_materials.length),ame));
 armor_materials.push("carbon crystal"); armor_matvalues.push(1.5); lp.c["armor material chances"].push(0.3*Math.pow(lp.f.r.hd(0,1,"armor material c"+armor_materials.length),ame));
 armor_materials.push("carbon polymer"); armor_matvalues.push(0.4); lp.c["armor material chances"].push(0.5*Math.pow(lp.f.r.hd(0,1,"armor material c"+armor_materials.length),ame));
 armor_materials.push("silicone"); armor_matvalues.push(0.4); lp.c["armor material chances"].push(0.1*Math.pow(lp.f.r.hd(0,1,"armor material c"+armor_materials.length),ame));
 armor_materials.push("borosilicate"); armor_matvalues.push(0.4); lp.c["armor material chances"].push(0.02*Math.pow(lp.f.r.hd(0,1,"armor material c"+armor_materials.length),ame));
 armor_materials.push("ceramic"); armor_matvalues.push(0.5); lp.c["armor material chances"].push(0.15*Math.pow(lp.f.r.hd(0,1,"armor material c"+armor_materials.length),ame));
 armor_materials.push("copper alloy"); armor_matvalues.push(0.5); lp.c["armor material chances"].push(0.3*Math.pow(lp.f.r.hd(0,1,"armor material c"+armor_materials.length),ame));
 armor_materials.push("nickel alloy"); armor_matvalues.push(0.5); lp.c["armor material chances"].push(0.2*Math.pow(lp.f.r.hd(0,1,"armor material c"+armor_materials.length),ame));
 armor_materials.push("unobtanium"); armor_matvalues.push(100); lp.c["armor material chances"].push(0.001*Math.pow(lp.f.r.hd(0,1,"armor material c"+armor_materials.length),ame));
 armor_constructions=[];
 lp.c["armor construction chances"]=[];
 armor_constructions.push("plating"); lp.c["armor construction chances"].push(1*lp.f.r.hd(0.5,1,"armor construction c"+armor_constructions.length));
 armor_constructions.push("mesh"); lp.c["armor construction chances"].push(0.5*lp.f.r.hd(0,1,"armor construction c"+armor_constructions.length));
 armor_constructions.push("weave"); lp.c["armor construction chances"].push(0.05*lp.f.r.hd(0,1,"armor construction c"+armor_constructions.length));
 armor_constructions.push("nanoweave"); lp.c["armor construction chances"].push(0.2*lp.f.r.hd(0,1,"armor construction c"+armor_constructions.length));
 armor_modifiers=[];
 lp.c["armor modifier chances"]=[];
 armor_modifiers.push("reinforced"); lp.c["armor modifier chances"].push(1*lp.f.r.hd(0.5,1,"armor modifier c"+armor_modifiers.length));
 armor_modifiers.push("interlocking"); lp.c["armor modifier chances"].push(0.7*lp.f.r.hd(0.1,1,"armor modifier c"+armor_modifiers.length));
 armor_modifiers.push("banded"); lp.c["armor modifier chances"].push(0.2*lp.f.r.hd(0,1,"armor modifier c"+armor_modifiers.length));
 armor_modifiers.push("tiled"); lp.c["armor modifier chances"].push(0.5*lp.f.r.hd(0,1,"armor modifier c"+armor_modifiers.length));
 armor_modifiers.push("double-layer"); lp.c["armor modifier chances"].push(0.7*lp.f.r.hd(0,1,"armor modifier c"+armor_modifiers.length));
 armor_modifiers.push("triple-layer"); lp.c["armor modifier chances"].push(0.3*lp.f.r.hd(0,1,"armor modifier c"+armor_modifiers.length));
 armor_modifiers.push("quad-layer"); lp.c["armor modifier chances"].push(0.2*lp.f.r.hd(0,1,"armor modifier c"+armor_modifiers.length));
 armor_modifiers.push("angled"); lp.c["armor modifier chances"].push(0.2*lp.f.r.hd(0,1,"armor modifier c"+armor_modifiers.length));
 armor_modifiers.push("reflective"); lp.c["armor modifier chances"].push(0.4*lp.f.r.hd(0,1,"armor modifier c"+armor_modifiers.length));
 armor_modifiers.push("mirrored"); lp.c["armor modifier chances"].push(0.1*lp.f.r.hd(0,1,"armor modifier c"+armor_modifiers.length));
 armor_modifiers.push("heat-resistant"); lp.c["armor modifier chances"].push(0.5*lp.f.r.hd(0,1,"armor modifier c"+armor_modifiers.length));
 armor_modifiers.push("shock-resistant"); lp.c["armor modifier chances"].push(0.5*lp.f.r.hd(0,1,"armor modifier c"+armor_modifiers.length));
 armor_modifiers.push("shock-absorbant"); lp.c["armor modifier chances"].push(0.2*lp.f.r.hd(0,1,"armor modifier c"+armor_modifiers.length));
 armor_modifiers.push("polarized"); lp.c["armor modifier chances"].push(0.1*lp.f.r.hd(0,1,"armor modifier c"+armor_modifiers.length));
 armor_modifiers.push("quantum-reinforced"); lp.c["armor modifier chances"].push(0.2*lp.f.r.hd(0,1,"armor modifier c"+armor_modifiers.length));
 armor_modifiers.push("quantum-polarized"); lp.c["armor modifier chances"].push(0.05*lp.f.r.hd(0,1,"armor modifier c"+armor_modifiers.length));
 armor_modifiers.push("reactive"); lp.c["armor modifier chances"].push(0.7*lp.f.r.hd(0,1,"armor modifier c"+armor_modifiers.length));
 armor_modifiers.push("auto-repairing"); lp.c["armor modifier chances"].push(1*lp.f.r.hd(0.1,1,"armor modifier c"+armor_modifiers.length));
 armor_modifiers.push("nano-reinforced"); lp.c["armor modifier chances"].push(0.4*lp.f.r.hd(0,1,"armor modifier c"+armor_modifiers.length));
 armor_modifiers.push("nano-interlocking"); lp.c["armor modifier chances"].push(0.1*lp.f.r.hd(0,1,"armor modifier c"+armor_modifiers.length));
 armor_modifiers.push("magnetically suspended"); lp.c["armor modifier chances"].push(0.1*lp.f.r.hd(0,1,"armor modifier c"+armor_modifiers.length));
 armor_modifiers.push("electroplated"); lp.c["armor modifier chances"].push(0.1*lp.f.r.hd(0.1,1,"armor modifier c"+armor_modifiers.length));
 armor_modifiers.push("hardened"); lp.c["armor modifier chances"].push(0.6*lp.f.r.hd(0.1,1,"armor modifier c"+armor_modifiers.length));
 armor_modifiers.push("chemically hardened"); lp.c["armor modifier chances"].push(0.2*lp.f.r.hd(0.1,1,"armor modifier c"+armor_modifiers.length));
 armor_modifiers.push("ribbed"); lp.c["armor modifier chances"].push(0.3*lp.f.r.hd(0.1,1,"armor modifier c"+armor_modifiers.length));
 armor_modifiers.push("corrugated"); lp.c["armor modifier chances"].push(0.3*lp.f.r.hd(0.1,1,"armor modifier c"+armor_modifiers.length));
}

function text_armor(lp,count)
{
 if(lp.c["armor material chances"]==null)
 {
  setup_armor(lp);
 }
 var materialid=lp.r.schoose(lp.c["armor material chances"]);
 var material=armor_materials[materialid];
 var construction=armor_constructions[lp.r.schoose(lp.c["armor construction chances"])];
 var thickness=1+Math.round((Math.pow(lp.r.sd(0.6,1.5),2)*(lp.c["militariness"]+0.3)*lp.size)/(Math.pow(count,0.8)*armor_matvalues[materialid]));
 if(thickness>=100 && lp.r.sb(0.7))
 {
  thickness=thickness-(thickness%10);
 }
 else if(thickness>=10 && lp.r.sb(0.3))
 {
  thickness=thickness-(thickness%5);
 }
 var modifier="";
 if(lp.r.sb(lp.f.c["armor modifier chance"]==null?lp.f.c["armor modifier chance"]=lp.f.r.hd(0.1,0.6,"armor modifier chance"):lp.f.c["armor modifier chance"]))
 {
  modifier=armor_modifiers[lp.r.schoose(lp.c["armor modifier chances"])]+" ";
 }
 return ((thickness+"mm ")+modifier+(material+" ")+construction);
}

var shield_types=[];
var shield_modifiers=[];

function setup_shields(lp)
{
 var aste=6; //Default shield type faction exponent.
 shield_types=[];
 lp.c["shield type chances"]=[];
 shield_types.push("electric shield"); lp.c["shield type chances"].push(1*Math.pow(lp.f.r.hd(0.1,1,"shield type c"+armor_constructions.length),aste));
 shield_types.push("magnetic shield"); lp.c["shield type chances"].push(1*Math.pow(lp.f.r.hd(0.1,1,"shield type c"+armor_constructions.length),aste));
 shield_types.push("antimagnetic shield"); lp.c["shield type chances"].push(0.6*Math.pow(lp.f.r.hd(0,1,"shield type c"+armor_constructions.length),aste));
 shield_types.push("proton shield"); lp.c["shield type chances"].push(0.4*Math.pow(lp.f.r.hd(0,1,"shield type c"+armor_constructions.length),aste));
 shield_types.push("positron shield"); lp.c["shield type chances"].push(0.4*Math.pow(lp.f.r.hd(0,1,"shield type c"+armor_constructions.length),aste));
 shield_types.push("plasma shield"); lp.c["shield type chances"].push(0.8*Math.pow(lp.f.r.hd(0,1,"shield type c"+armor_constructions.length),aste));
 shield_types.push("quantum shield"); lp.c["shield type chances"].push(0.5*Math.pow(lp.f.r.hd(0,1,"shield type c"+armor_constructions.length),aste));
 shield_types.push("particle shield"); lp.c["shield type chances"].push(0.7*Math.pow(lp.f.r.hd(0,1,"shield type c"+armor_constructions.length),aste));
 shield_types.push("graviton shield"); lp.c["shield type chances"].push(0.2*Math.pow(lp.f.r.hd(0,1,"shield type c"+armor_constructions.length),aste));
 shield_types.push("tachyonic shield"); lp.c["shield type chances"].push(0.3*Math.pow(lp.f.r.hd(0,1,"shield type c"+armor_constructions.length),aste));
 shield_types.push("dark energy shield"); lp.c["shield type chances"].push(0.3*Math.pow(lp.f.r.hd(0,1,"shield type c"+armor_constructions.length),aste));
 shield_types.push("distortion shield"); lp.c["shield type chances"].push(0.1*Math.pow(lp.f.r.hd(0,1,"shield type c"+armor_constructions.length),aste));
 shield_types.push("displacement shield"); lp.c["shield type chances"].push(0.1*Math.pow(lp.f.r.hd(0,1,"shield type c"+armor_constructions.length),aste));
 shield_types.push("repulsor shield"); lp.c["shield type chances"].push(0.1*Math.pow(lp.f.r.hd(0,1,"shield type c"+armor_constructions.length),aste));
 shield_types.push("stasis shield"); lp.c["shield type chances"].push(0.02*Math.pow(lp.f.r.hd(0,1,"shield type c"+armor_constructions.length),aste));
 shield_types.push("damper field"); lp.c["shield type chances"].push(0.1*Math.pow(lp.f.r.hd(0,1,"shield type c"+armor_constructions.length),aste));
 shield_types.push("reflection field"); lp.c["shield type chances"].push(0.1*Math.pow(lp.f.r.hd(0,1,"shield type c"+armor_constructions.length),aste));
 shield_types.push("lightning shield"); lp.c["shield type chances"].push(0.05*Math.pow(lp.f.r.hd(0,1,"shield type c"+armor_constructions.length),aste));
 var asme=5; //Default shield modifier faction exponent.
 shield_modifiers=[];
 lp.c["shield modifier chances"]=[];
 shield_modifiers.push("heavy"); lp.c["shield modifier chances"].push(1*Math.pow(lp.f.r.hd(0.1,1,"shield modifier c"+armor_constructions.length),asme));
 shield_modifiers.push("double-layer"); lp.c["shield modifier chances"].push(0.8*Math.pow(lp.f.r.hd(0,1,"shield modifier c"+armor_constructions.length),asme));
 shield_modifiers.push("triple-layer"); lp.c["shield modifier chances"].push(0.6*Math.pow(lp.f.r.hd(0,1,"shield modifier c"+armor_constructions.length),asme));
 shield_modifiers.push("quad-layer"); lp.c["shield modifier chances"].push(0.4*Math.pow(lp.f.r.hd(0,1,"shield modifier c"+armor_constructions.length),asme));
 shield_modifiers.push("gradiated"); lp.c["shield modifier chances"].push(0.6*Math.pow(lp.f.r.hd(0,1,"shield modifier c"+armor_constructions.length),asme));
 shield_modifiers.push("phased"); lp.c["shield modifier chances"].push(0.6*Math.pow(lp.f.r.hd(0,1,"shield modifier c"+armor_constructions.length),asme));
 shield_modifiers.push("multi-phased"); lp.c["shield modifier chances"].push(0.2*Math.pow(lp.f.r.hd(0,1,"shield modifier c"+armor_constructions.length),asme));
 shield_modifiers.push("hyperphased"); lp.c["shield modifier chances"].push(0.2*Math.pow(lp.f.r.hd(0,1,"shield modifier c"+armor_constructions.length),asme));
 shield_modifiers.push("reactive"); lp.c["shield modifier chances"].push(0.5*Math.pow(lp.f.r.hd(0,1,"shield modifier c"+armor_constructions.length),asme));
 shield_modifiers.push("dynamic"); lp.c["shield modifier chances"].push(0.3*Math.pow(lp.f.r.hd(0,1,"shield modifier c"+armor_constructions.length),asme));
 shield_modifiers.push("dynamically phased"); lp.c["shield modifier chances"].push(0.1*Math.pow(lp.f.r.hd(0,1,"shield modifier c"+armor_constructions.length),asme));
 shield_modifiers.push("hex-arrayed"); lp.c["shield modifier chances"].push(0.1*Math.pow(lp.f.r.hd(0,1,"shield modifier c"+armor_constructions.length),asme));
 shield_modifiers.push("magnetically reinforced"); lp.c["shield modifier chances"].push(0.3*Math.pow(lp.f.r.hd(0,1,"shield modifier c"+armor_constructions.length),asme));
 shield_modifiers.push("gravitationally reinforced"); lp.c["shield modifier chances"].push(0.1*Math.pow(lp.f.r.hd(0,1,"shield modifier c"+armor_constructions.length),asme));
}

function text_shield(lp,count)
{
 if(lp.c["shields"]==null)
 {
  setup_shields(lp);
 }
 var shieldtypeid=lp.r.schoose(lp.c["shield type chances"]);
 var shieldtype=shield_types[shieldtypeid];
 var shieldmodifierid=lp.r.schoose(lp.c["shield modifier chances"]);
 var shieldmodifier=shield_modifiers[shieldmodifierid];
 lp.c["baseshieldpower"]=lp.c["powerlevel"]*lp.r.hd(0.2,0.7,"shield power")*lp.f.r.hd(0.2,0.7,"shield power")*(lp.c["militariness"]+0.5);
 var lshieldpower=Math.floor((lp.c["baseshieldpower"]*lp.r.sd(0.1,1))/count);
 var power=lshieldpower+"W";
 if(lshieldpower>=2000000000000)
 {
  power=Math.floor(lshieldpower/1000000000000)+"TW";
 }
 else if(lshieldpower>=2000000000)
 {
  power=Math.floor(lshieldpower/1000000000)+"GW";
 }
 else if(lshieldpower>=2000000)
 {
  power=Math.floor(lshieldpower/1000000)+"MW";
 }
 else if(lshieldpower>=2000)
 {
  power=Math.floor(lshieldpower/1000)+"KW";
 }
 return ((power+" ")+(lp.r.sb(0.7)?shieldmodifier+" ":"")+shieldtype);
}

function text_defense(lp)
{
 var rv="<b><span style='color:#dddddd;'>Defense:</span></b><br><span style='color:#eeddcc;'>";
 var armorchance=1-(1/(((lp.r.sd(0,20)+(lp.c["militariness"]*30)+Math.pow(lp.size,0.7))*0.01)+1));
 var armorcount=1+(lp.r.sb(lp.c["militariness"]-0.2)?1:0)+lp.r.sseq(armorchance,4);
 var armors=[];
 for(var tries=0;(tries<1000 && armors.length<armorcount);tries++)
 {
  var na=text_armor(lp,armorcount);
  if(!arraycontains(armors,na))
  {
   armors.push(na);
   rv=rv+(na+"<br>");
  }
 }
 rv=rv+"</span><span style='color:#aaeeff;'>";
 var shieldchance=1-(1/(((lp.r.sd(0,10)+(lp.c["militariness"]*20)+Math.pow(lp.size,0.7))*0.01)+1));
 var shieldcount=(lp.r.sb((lp.c["militariness"]*2)-1.1)?1:0)+lp.r.sseq(shieldchance,3);
 var shields=[];
 for(var tries=0;(tries<1000 && shields.length<shieldcount);tries++)
 {
  var ns=text_shield(lp,shieldcount);
  if(!arraycontains(shields,ns))
  {
   shields.push(ns);
   rv=rv+(ns+"<br>");
  }
 }
 rv=rv+"</span>";
 return rv;
}

//END DEFENSE

//START WEAPONS

var wep_basetypes=null;

var wep_beamenergytypes=null;
var wep_beammounttypes=null;
var wep_beammodifiers=null;

var wep_projectiletypes=null;
var wep_projectilemodifiers=null;

var wep_explosivetypes=null;

var wep_missilemodifiers=null;

var wep_specialtypes=null;

function setup_weapons(lp)
{
 var wfe=2; //Default weapon faction exponent.
 wep_basetypes=[];
 lp.c["wep basetypec"]=[];
 wep_basetypes.push(text_beam); lp.c["wep basetypec"].push(1*((1+lp.c["militariness"])/2)*Math.pow(lp.f.r.hd(0.1,1,"wep basetype c"+wep_basetypes.length),wfe));
 wep_basetypes.push(text_projectile); lp.c["wep basetypec"].push(0.7*((1+lp.c["militariness"])/2)*Math.pow(lp.f.r.hd(0.1,1,"wep basetype c"+wep_basetypes.length),wfe));
 wep_basetypes.push(text_missile); lp.c["wep basetypec"].push(0.9*((1+lp.c["militariness"])/2)*Math.pow(lp.f.r.hd(0.1,1,"wep basetype c"+wep_basetypes.length),wfe));
 wep_basetypes.push(text_bomb); lp.c["wep basetypec"].push(0.3*((1+lp.c["militariness"])/2)*Math.pow(lp.f.r.hd(0.02,1,"wep basetype c"+wep_basetypes.length),wfe));
 wep_basetypes.push(text_fighter); lp.c["wep basetypec"].push(0.2*Math.pow(lp.f.r.hd(0,1,"wep basetype c"+wep_basetypes.length),wfe));
 wep_basetypes.push(text_specialweapon); lp.c["wep basetypec"].push(0.05*((2-lp.c["militariness"])/2)*lp.f.r.hd(0.5,1,"wep basetype c"+wep_basetypes.length));
 wfe=5;
 wep_beamenergytypes=[];
 lp.c["wep beamenergytypec"]=[];
 wep_beamenergytypes.push("laser"); lp.c["wep beamenergytypec"].push(1*Math.pow(lp.f.r.hd(0.1,1,"wep beamenergytype c"+wep_beamenergytypes.length),wfe));
 wep_beamenergytypes.push("maser"); lp.c["wep beamenergytypec"].push(0.3*Math.pow(lp.f.r.hd(0,1,"wep beamenergytype c"+wep_beamenergytypes.length),wfe));
 wep_beamenergytypes.push("x-ray laser"); lp.c["wep beamenergytypec"].push(0.2*Math.pow(lp.f.r.hd(0,1,"wep beamenergytype c"+wep_beamenergytypes.length),wfe));
 wep_beamenergytypes.push("graser"); lp.c["wep beamenergytypec"].push(0.4*Math.pow(lp.f.r.hd(0,1,"wep beamenergytype c"+wep_beamenergytypes.length),wfe));
 wep_beamenergytypes.push("plasma"); lp.c["wep beamenergytypec"].push(1*Math.pow(lp.f.r.hd(0,1,"wep beamenergytype c"+wep_beamenergytypes.length),wfe));
 wep_beamenergytypes.push("particle"); lp.c["wep beamenergytypec"].push(0.6*Math.pow(lp.f.r.hd(0,1,"wep beamenergytype c"+wep_beamenergytypes.length),wfe));
 wep_beamenergytypes.push("proton"); lp.c["wep beamenergytypec"].push(0.6*Math.pow(lp.f.r.hd(0,1,"wep beamenergytype c"+wep_beamenergytypes.length),wfe));
 wep_beamenergytypes.push("positron"); lp.c["wep beamenergytypec"].push(0.2*Math.pow(lp.f.r.hd(0,1,"wep beamenergytype c"+wep_beamenergytypes.length),wfe));
 wep_beamenergytypes.push("neutron"); lp.c["wep beamenergytypec"].push(0.6*Math.pow(lp.f.r.hd(0,1,"wep beamenergytype c"+wep_beamenergytypes.length),wfe));
 wep_beamenergytypes.push("neutrino"); lp.c["wep beamenergytypec"].push(0.01*Math.pow(lp.f.r.hd(0,1,"wep beamenergytype c"+wep_beamenergytypes.length),wfe));
 wep_beamenergytypes.push("antiplasma"); lp.c["wep beamenergytypec"].push(0.2*Math.pow(lp.f.r.hd(0,1,"wep beamenergytype c"+wep_beamenergytypes.length),wfe));
 wep_beamenergytypes.push("dark energy"); lp.c["wep beamenergytypec"].push(0.1*Math.pow(lp.f.r.hd(0,1,"wep beamenergytype c"+wep_beamenergytypes.length),wfe));
 wep_beamenergytypes.push("magnetic beam"); lp.c["wep beamenergytypec"].push(0.1*Math.pow(lp.f.r.hd(0,1,"wep beamenergytype c"+wep_beamenergytypes.length),wfe));
 wep_beamenergytypes.push("graviton"); lp.c["wep beamenergytypec"].push(0.3*Math.pow(lp.f.r.hd(0,1,"wep beamenergytype c"+wep_beamenergytypes.length),wfe));
 wep_beamenergytypes.push("phasor"); lp.c["wep beamenergytypec"].push(0.2*Math.pow(lp.f.r.hd(0,1,"wep beamenergytype c"+wep_beamenergytypes.length),wfe));
 wfe=2;
 wep_beammounttypes=[];
 lp.c["wep beammounttypec"]=[];
 wep_beammounttypes.push("cannon"); lp.c["wep beammounttypec"].push(1*Math.pow(lp.f.r.hd(0.1,1,"wep beammounttype c"+wep_beammounttypes.length),wfe));
 wep_beammounttypes.push("turret"); lp.c["wep beammounttypec"].push(1*((2-lp.c["militariness"])/2)*Math.pow(lp.f.r.hd(0.1,1,"wep beammounttype c"+wep_beammounttypes.length),wfe));
 wep_beammounttypes.push("battery"); lp.c["wep beammounttypec"].push(0.7*((1+lp.c["militariness"])/2)*Math.pow(lp.f.r.hd(0,1,"wep beammounttype c"+wep_beammounttypes.length),wfe));
 wfe=5;
 wep_beammodifiers=[];
 lp.c["wep beammodifierc"]=[];
 wep_beammodifiers.push("twin"); lp.c["wep beammodifierc"].push(1*Math.pow(lp.f.r.hd(0.1,1,"wep beammodifier c"+wep_beammodifiers.length),wfe));
 wep_beammodifiers.push("triple"); lp.c["wep beammodifierc"].push(0.4*Math.pow(lp.f.r.hd(0,1,"wep beammodifier c"+wep_beammodifiers.length),wfe));
 wep_beammodifiers.push("quad"); lp.c["wep beammodifierc"].push(0.6*Math.pow(lp.f.r.hd(0.01,1,"wep beammodifier c"+wep_beammodifiers.length),wfe));
 wep_beammodifiers.push("rotary"); lp.c["wep beammodifierc"].push(0.8*Math.pow(lp.f.r.hd(0,1,"wep beammodifier c"+wep_beammodifiers.length),wfe));
 wep_beammodifiers.push("repeating"); lp.c["wep beammodifierc"].push(0.7*Math.pow(lp.f.r.hd(0,1,"wep beammodifier c"+wep_beammodifiers.length),wfe));
 wep_beammodifiers.push("pulsed"); lp.c["wep beammodifierc"].push(1*Math.pow(lp.f.r.hd(0,1,"wep beammodifier c"+wep_beammodifiers.length),wfe));
 wep_beammodifiers.push("focused"); lp.c["wep beammodifierc"].push(1*Math.pow(lp.f.r.hd(0,1,"wep beammodifier c"+wep_beammodifiers.length),wfe));
 wep_beammodifiers.push("point-defense"); lp.c["wep beammodifierc"].push(1*((2-lp.c["militariness"])/2)*Math.pow(lp.f.r.hd(0,1,"wep beammodifier c"+wep_beammodifiers.length),wfe));
 wep_beammodifiers.push("auto-targeting"); lp.c["wep beammodifierc"].push(1*((2-lp.c["militariness"])/2)*Math.pow(lp.f.r.hd(0,1,"wep beammodifier c"+wep_beammodifiers.length),wfe));
 wfe=4;
 wep_projectiletypes=[];
 lp.c["wep projectiletypec"]=[];
 wep_projectiletypes.push("kinetic shell"); lp.c["wep projectiletypec"].push(1*Math.pow(lp.f.r.hd(0.1,1,"wep projectiletype c"+wep_projectiletypes.length),wfe));
 wep_projectiletypes.push("explosive shell"); lp.c["wep projectiletypec"].push(1*Math.pow(lp.f.r.hd(0.1,1,"wep projectiletype c"+wep_projectiletypes.length),wfe));
 wep_projectiletypes.push("flak"); lp.c["wep projectiletypec"].push(0.7*((2-lp.c["militariness"])/2)*Math.pow(lp.f.r.hd(0,1,"wep projectiletype c"+wep_projectiletypes.length),wfe));
 wep_projectiletypes.push("shotgun"); lp.c["wep projectiletypec"].push(0.4*Math.pow(lp.f.r.hd(0,1,"wep projectiletype c"+wep_projectiletypes.length),wfe));
 wep_projectiletypes.push("antimatter shell"); lp.c["wep projectiletypec"].push(0.25*Math.pow(lp.f.r.hd(0,1,"wep projectiletype c"+wep_projectiletypes.length),wfe));
 wep_projectiletypes.push("proton shell"); lp.c["wep projectiletypec"].push(0.1*Math.pow(lp.f.r.hd(0,1,"wep projectiletype c"+wep_projectiletypes.length),wfe));
 wfe=4;
 wep_projectilemodifiers=[];
 lp.c["wep projectilemodifierc"]=[];
 wep_projectilemodifiers.push("twin"); lp.c["wep projectilemodifierc"].push(1*Math.pow(lp.f.r.hd(0.1,1,"wep projectilemodifier c"+wep_projectilemodifiers.length),wfe));
 wep_projectilemodifiers.push("triple"); lp.c["wep projectilemodifierc"].push(0.3*Math.pow(lp.f.r.hd(0,1,"wep projectilemodifier c"+wep_projectilemodifiers.length),wfe));
 wep_projectilemodifiers.push("quad"); lp.c["wep projectilemodifierc"].push(0.5*Math.pow(lp.f.r.hd(0.01,1,"wep projectilemodifier c"+wep_projectilemodifiers.length),wfe));
 wep_projectilemodifiers.push("rotary"); lp.c["wep projectilemodifierc"].push(0.8*Math.pow(lp.f.r.hd(0,1,"wep projectilemodifier c"+wep_projectilemodifiers.length),wfe));
 wep_projectilemodifiers.push("repeating"); lp.c["wep projectilemodifierc"].push(0.7*Math.pow(lp.f.r.hd(0,1,"wep projectilemodifier c"+wep_projectilemodifiers.length),wfe));
 wep_projectilemodifiers.push("armor-piercing"); lp.c["wep projectilemodifierc"].push(0.3*lp.c["militariness"]*Math.pow(lp.f.r.hd(0,1,"wep projectilemodifier c"+wep_projectilemodifiers.length),wfe));
 wep_projectilemodifiers.push("point-defense"); lp.c["wep projectilemodifierc"].push(1*((2-lp.c["militariness"])/2)*Math.pow(lp.f.r.hd(0,1,"wep projectilemodifier c"+wep_projectilemodifiers.length),wfe));
 wep_projectilemodifiers.push("auto-targeting"); lp.c["wep projectilemodifierc"].push(1*((2-lp.c["militariness"])/2)*Math.pow(lp.f.r.hd(0,1,"wep projectilemodifier c"+wep_projectilemodifiers.length),wfe));
 wfe=5;
 wep_explosivetypes=[];
 lp.c["wep explosivetypec"]=[];
 wep_explosivetypes.push("high-explosive"); lp.c["wep explosivetypec"].push(1*Math.pow(lp.f.r.hd(0.1,1,"wep explosivetype c"+wep_explosivetypes.length),wfe));
 wep_explosivetypes.push("incendiary"); lp.c["wep explosivetypec"].push(0.2*Math.pow(lp.f.r.hd(0,1,"wep explosivetype c"+wep_explosivetypes.length),wfe));
 wep_explosivetypes.push("thermobaric"); lp.c["wep explosivetypec"].push(0.1*Math.pow(lp.f.r.hd(0,1,"wep explosivetype c"+wep_explosivetypes.length),wfe));
 wep_explosivetypes.push("fragmentation"); lp.c["wep explosivetypec"].push(0.5*Math.pow(lp.f.r.hd(0,1,"wep explosivetype c"+wep_explosivetypes.length),wfe));
 wep_explosivetypes.push("nuclear fission"); lp.c["wep explosivetypec"].push(0.7*Math.pow(lp.f.r.hd(0,1,"wep explosivetype c"+wep_explosivetypes.length),wfe));
 wep_explosivetypes.push("thermonuclear"); lp.c["wep explosivetypec"].push(0.6*Math.pow(lp.f.r.hd(0,1,"wep explosivetype c"+wep_explosivetypes.length),wfe));
 wep_explosivetypes.push("nuclear fusion"); lp.c["wep explosivetypec"].push(0.9*Math.pow(lp.f.r.hd(0,1,"wep explosivetype c"+wep_explosivetypes.length),wfe));
 wep_explosivetypes.push("antimatter"); lp.c["wep explosivetypec"].push(0.5*Math.pow(lp.f.r.hd(0,1,"wep explosivetype c"+wep_explosivetypes.length),wfe));
 wep_explosivetypes.push("proton"); lp.c["wep explosivetypec"].push(0.3*Math.pow(lp.f.r.hd(0,1,"wep explosivetype c"+wep_explosivetypes.length),wfe));
 wep_explosivetypes.push("neutron"); lp.c["wep explosivetypec"].push(0.3*Math.pow(lp.f.r.hd(0,1,"wep explosivetype c"+wep_explosivetypes.length),wfe));
 wep_explosivetypes.push("neutronium"); lp.c["wep explosivetypec"].push(0.1*Math.pow(lp.f.r.hd(0,1,"wep explosivetype c"+wep_explosivetypes.length),wfe));
 wep_explosivetypes.push("gravity pulse"); lp.c["wep explosivetypec"].push(0.1*Math.pow(lp.f.r.hd(0,1,"wep explosivetype c"+wep_explosivetypes.length),wfe));
 wep_explosivetypes.push("poison gas"); lp.c["wep explosivetypec"].push(0.1*Math.pow(lp.f.r.hd(0,1,"wep explosivetype c"+wep_explosivetypes.length),wfe));
 wep_explosivetypes.push("biochemical"); lp.c["wep explosivetypec"].push(0.1*Math.pow(lp.f.r.hd(0,1,"wep explosivetype c"+wep_explosivetypes.length),wfe));
 wep_explosivetypes.push("bio-infector"); lp.c["wep explosivetypec"].push(0.05*Math.pow(lp.f.r.hd(0,1,"wep explosivetype c"+wep_explosivetypes.length),wfe));
 wfe=3;
 wep_missilemodifiers=[];
 lp.c["wep missilemodifierc"]=[];
 wep_missilemodifiers.push("high-speed"); lp.c["wep missilemodifierc"].push(1*Math.pow(lp.f.r.hd(0.1,1,"wep missilemodifier c"+wep_missilemodifiers.length),wfe));
 wep_missilemodifiers.push("MIRV"); lp.c["wep missilemodifierc"].push(1*Math.pow(lp.f.r.hd(0.1,1,"wep missilemodifier c"+wep_missilemodifiers.length),wfe));
 wep_missilemodifiers.push("self-guided"); lp.c["wep missilemodifierc"].push(1*Math.pow(lp.f.r.hd(0.1,1,"wep missilemodifier c"+wep_missilemodifiers.length),wfe));
 wep_missilemodifiers.push("remote-guided"); lp.c["wep missilemodifierc"].push(0.5*Math.pow(lp.f.r.hd(0.1,1,"wep missilemodifier c"+wep_missilemodifiers.length),wfe));
 wep_missilemodifiers.push("laser-guided"); lp.c["wep missilemodifierc"].push(0.2*Math.pow(lp.f.r.hd(0.1,1,"wep missilemodifier c"+wep_missilemodifiers.length),wfe));
 wep_missilemodifiers.push("heavily armored"); lp.c["wep missilemodifierc"].push(1*Math.pow(lp.f.r.hd(0.1,1,"wep missilemodifier c"+wep_missilemodifiers.length),wfe));
 wfe=6;
 wep_specialtypes=[];
 lp.c["wep specialtypec"]=[];
 wep_specialtypes.push(tsw_minelayer); lp.c["wep specialtypec"].push(1*((1+lp.c["militariness"])/2)*Math.pow(lp.f.r.hd(0,1,"wep specialtype c"+wep_specialtypes.length),wfe));
 wep_specialtypes.push(tsw_assaultshuttles); lp.c["wep specialtypec"].push(0.7*((1+lp.c["militariness"])/2)*Math.pow(lp.f.r.hd(0.001,1,"wep specialtype c"+wep_specialtypes.length),wfe));
 wep_specialtypes.push(tsw_quantumdestructor); lp.c["wep specialtypec"].push(0.5*((1+lp.c["militariness"])/2)*Math.pow(lp.f.r.hd(0,1,"wep specialtype c"+wep_specialtypes.length),wfe));
 wep_specialtypes.push(tsw_tractorbeam); lp.c["wep specialtypec"].push(0.6*Math.pow(lp.f.r.hd(0,1,"wep specialtype c"+wep_specialtypes.length),wfe));
 wep_specialtypes.push(tsw_acid); lp.c["wep specialtypec"].push(0.2*Math.pow(lp.f.r.hd(0,1,"wep specialtype c"+wep_specialtypes.length),wfe));
 wep_specialtypes.push(tsw_buzzsaw); lp.c["wep specialtypec"].push(0.1*((1+lp.c["militariness"])/2)*Math.pow(lp.f.r.hd(0,1,"wep specialtype c"+wep_specialtypes.length),wfe));
 wep_specialtypes.push(tsw_freezeray); lp.c["wep specialtypec"].push(0.2*Math.pow(lp.f.r.hd(0,1,"wep specialtype c"+wep_specialtypes.length),wfe));
 wep_specialtypes.push(tsw_claw); lp.c["wep specialtypec"].push(0.1*(lp.t_type.indexOf("mining")>=0?4:1)*Math.pow(lp.f.r.hd(0,1,"wep specialtype c"+wep_specialtypes.length),wfe));
 wep_specialtypes.push(tsw_drill); lp.c["wep specialtypec"].push(0.1*(lp.t_type.indexOf("mining")>=0?20:1)*Math.pow(lp.f.r.hd(0,1,"wep specialtype c"+wep_specialtypes.length),wfe));
 wep_specialtypes.push(tsw_nanomachines); lp.c["wep specialtypec"].push(0.8*((1+lp.c["militariness"])/2)*Math.pow(lp.f.r.hd(0,1,"wep specialtype c"+wep_specialtypes.length),wfe));
 wep_specialtypes.push(tsw_fireball); lp.c["wep specialtypec"].push(1*((1+lp.c["militariness"])/2)*Math.pow(lp.f.r.hd(0,1,"wep specialtype c"+wep_specialtypes.length),wfe));
 wep_specialtypes.push(tsw_stasis); lp.c["wep specialtypec"].push(0.4*((2-lp.c["militariness"])/2)*Math.pow(lp.f.r.hd(0,1,"wep specialtype c"+wep_specialtypes.length),wfe));
 wep_specialtypes.push(tsw_lightning); lp.c["wep specialtypec"].push(0.9*((1+lp.c["militariness"])/2)*Math.pow(lp.f.r.hd(0,1,"wep specialtype c"+wep_specialtypes.length),wfe));
 wep_specialtypes.push(tsw_beamlance); lp.c["wep specialtypec"].push(0.9*((1+lp.c["militariness"])/2)*Math.pow(lp.f.r.hd(0,1,"wep specialtype c"+wep_specialtypes.length),wfe));
 wep_specialtypes.push(tsw_beamvortex); lp.c["wep specialtypec"].push(0.1*Math.pow(lp.f.r.hd(0,1,"wep specialtype c"+wep_specialtypes.length),wfe));
}

function text_beam(lp,wpower)
{
 var lenergytype=wep_beamenergytypes[lp.r.schoose(lp.c["wep beamenergytypec"])]+" ";
 var lmounttype=wep_beammounttypes[lp.r.schoose(lp.c["wep beammounttypec"])];
 var lmodifier="";
 if(lp.r.sb(lp.f.c["beam modifier chance"]==null?lp.f.c["beam modifier chance"]=lp.f.r.hd(0.2,0.6,"beam modifier chance"):lp.f.c["beam modifier chance"]))
 {
  lmodifier=wep_beammodifiers[lp.r.schoose(lp.c["wep beammodifierc"])]+" ";
 }
 var rv=lmodifier+lenergytype+lmounttype;
 if(lp.r.sb(1-(1/((Math.pow(wpower,0.1))+1))))
 {
  if(lp.r.sb(lp.f.c["beam multiple chance"]==null?lp.f.c["beam multiple chance"]=lp.f.r.hd(0.4,0.9,"beam multiple chance"):lp.f.c["beam multiple chance"]))
  {
   var count=2+Math.floor(Math.pow(wpower,0.25)*Math.pow(lp.r.sd(0,1),3));
   if(count%2==1 && lp.r.sb(0.6))
   {
    count--;
   }
   rv=(count+"x ")+rv+"s";
   rv=rv.replace("batterys","batteries");
  }
  else if(lp.r.sb((lp.c["militariness"]*0.9)+0.05))
  {
   rv=(lp.r.sb(0.5)?"large ":"heavy ")+rv;
  }
 }
 return rv;
}

function text_projectile(lp,wpower)
{
 var lprojectiletype=wep_projectiletypes[lp.r.schoose(lp.c["wep projectiletypec"])]+" ";
 var lmounttype=wep_beammounttypes[lp.r.schoose(lp.c["wep beammounttypec"])];
 var lmodifier="";
 if(lp.r.sb(lp.f.c["projectile modifier chance"]==null?lp.f.c["projectile modifier chance"]=lp.f.r.hd(0.2,0.6,"projectile modifier chance"):lp.f.c["projectile modifier chance"]))
 {
  lmodifier=wep_projectilemodifiers[lp.r.schoose(lp.c["wep projectilemodifierc"])]+" ";
 }
 var rv=lmodifier+lprojectiletype+lmounttype;
 if(lp.r.sb(1-(1/((Math.pow(wpower,0.09))+1))))
 {
  if(lp.r.sb(lp.f.c["projectile multiple chance"]==null?lp.f.c["projectile multiple chance"]=lp.f.r.hd(0.4,0.9,"projectile multiple chance"):lp.f.c["projectile multiple chance"]))
  {
   var count=2+Math.floor(Math.pow(wpower,0.25)*Math.pow(lp.r.sd(0,1),3));
   if(count%2==1 && lp.r.sb(0.6))
   {
    count--;
   }
   rv=(count+"x ")+rv+"s";
   rv=rv.replace("batterys","batteries");
  }
  else if(lp.r.sb((lp.c["militariness"]*0.9)+0.05))
  {
   rv=(lp.r.sb(0.5)?"large ":"heavy ")+rv;
  }
 }
 return rv;
}

function text_missile(lp,wpower)
{
 var lexplosivetype=wep_explosivetypes[lp.r.schoose(lp.c["wep explosivetypec"])]+" ";
 var lmodifier="";
 if(lp.r.sb(lp.f.c["missile modifier chance"]==null?lp.f.c["missile modifier chance"]=lp.f.r.hd(0.2,0.6,"missile modifier chance"):lp.f.c["missile modifier chance"]))
 {
  lmodifier=wep_missilemodifiers[lp.r.schoose(lp.c["wep missilemodifierc"])]+" ";
 }
 var rv=(lmodifier+lexplosivetype)+(["missile","rocket","torpedo"][lp.r.schoose([1,0.2,0.4])]+" launcher");
 if(lp.r.sb(1-(1/((Math.pow(wpower,0.07))+1))))
 {
  if(lp.r.sb(lp.f.c["missile multiple chance"]==null?lp.f.c["missile multiple chance"]=lp.f.r.hd(0.2,0.8,"missile multiple chance"):lp.f.c["missile multiple chance"]))
  {
   var count=2+Math.floor(Math.pow(wpower,0.2)*Math.pow(lp.r.sd(0,1),3));
   if(count%2==1 && lp.r.sb(0.3))
   {
    count--;
   }
   rv=(count+"x ")+(rv+"s");
  }
  else if(lp.r.sb((lp.c["militariness"]*0.9)+0.05))
  {
   rv=(lp.r.sb(0.5)?"large ":"heavy ")+rv;
  }
 }
 return rv;
}

function text_bomb(lp,wpower)
{
 var lexplosivetype=wep_explosivetypes[lp.r.schoose(lp.c["wep explosivetypec"])]+" ";
 var rv=lexplosivetype+" bomb bay";
 if(lp.r.sb(1-(1/((Math.pow(wpower,0.08))+1))))
 {
  if(lp.r.sb(lp.f.c["bomb multiple chance"]==null?lp.f.c["bomb multiple chance"]=lp.f.r.hd(0.3,0.9,"bomb multiple chance"):lp.f.c["bomb multiple chance"]))
  {
   var count=2+Math.floor(Math.pow(wpower,0.25)*Math.pow(lp.r.sd(0,0.8),3));
   if(count%2==1 && lp.r.sb(0.3))
   {
    count--;
   }
   rv=(count+"x ")+(rv+"s");
  }
  else if(lp.r.sb((lp.c["militariness"]*0.9)+0.05))
  {
   rv=(lp.r.sb(0.4)?"large ":"heavy ")+rv;
  }
 }
 return rv;
}

function text_fighter(lp,wpower)
{
 var lfightertype=["fighter","interceptor","drone","attack drone","interceptor drone"][lp.r.schoose([1,0.5,0.7,0.1,0.05])];
 rv="shipboard "+lfightertype;
 if(lp.r.sb(1-(1/((Math.pow(wpower,0.05))+1))))
 {
  var count=2+Math.floor(Math.pow(wpower,0.2)*Math.pow(lp.r.sd(0,0.8),3));
  if(count%2==1 && lp.r.sb(0.3))
  {
   count--;
  }
  rv=(count+"x ")+(rv+"s");
 }
 if(lp.c["drive subl chances"]==null)
 {
  setup_drives(lp);
 }
 var lfdrivetext=drive_subl[lp.r.schoose(lp.c["drive subl chances"])];
 if(lp.c["armor material chances"]==null)
 {
  setup_armor(lp);
 }
 var lfarmortext=((lp.r.sb(0.2)?armor_modifiers[lp.r.schoose(lp.c["armor modifier chances"])]+" ":"")+armor_materials[lp.r.schoose(lp.c["armor material chances"])])+(" "+armor_constructions[lp.r.schoose(lp.c["armor construction chances"])]);
 var lfshieldtext="";
 if(lp.r.sb(lp.f.c["fighter shield chance"]==null?lp.f.c["fighter shield chance"]=lp.f.r.hd(0,0.3,"fighter shield chance"):lp.f.c["fighter shield chance"]))
 {
  if(lp.c["shields"]==null)
  {
   setup_shields(lp);
  }
  lfshieldtext=(lp.r.sb(0.2)?shield_modifiers[lp.r.schoose(lp.c["shield modifier chances"])]+" ":"")+shield_types[lp.r.schoose(lp.c["shield type chances"])];
 }
 var lfweaponchances=[1,0.5,0.2];
 var lfweaponcount=1+lp.r.sseq(0.1,3);
 var lfweapontext="";
 var lfweapons=[];
 for(var tries=0;(tries<1000 && lfweapons.length<lfweaponcount);tries++)
 {
  var lfwtype=lp.r.schoose(lfweaponchances);
  var nw="";
  switch(lfwtype)
  {
   case 0:
    var beamcount=1+lp.r.sseq(0.2,4);
    nw=(beamcount>1?beamcount+"x ":"")+(lp.r.sb(0.3)?wep_beammodifiers[lp.r.schoose(lp.c["wep beammodifierc"])]+" ":"")+wep_beamenergytypes[lp.r.schoose(lp.c["wep beamenergytypec"])]+" cannon"+(beamcount>1?"s":"");
    break;
   case 1:
    var projectilecount=1+lp.r.sseq(0.2,4);
    nw=(projectilecount>1?projectilecount+"x ":"")+(lp.r.sb(0.3)?wep_projectilemodifiers[lp.r.schoose(lp.c["wep projectilemodifierc"])]+" ":"")+wep_projectiletypes[lp.r.schoose(lp.c["wep projectiletypec"])]+" cannon"+(projectilecount>1?"s":"");
    break;
   case 2:
    var missilecount=1+lp.r.sseq(0.1,2);
    nw=(missilecount>1?missilecount+"x ":"")+(lp.r.sb(0.2)?wep_missilemodifiers[lp.r.schoose(lp.c["wep missilemodifierc"])]+" ":"")+wep_explosivetypes[lp.r.schoose(lp.c["wep explosivetypec"])]+" "+(["missile","rocket","torpedo"][lp.r.schoose([0.8,1,0.6])]+" launcher")+(missilecount>1?"s":"");
    break;
  }
  if(!arraycontains(lfweapons,nw))
  {
   lfweapontext=lfweapontext+((lfweapons.length>0?", ":"")+nw);
   lfweapons.push(nw);
  }
 }
 rv=rv+(((" <i>(loadout: "+lfweapontext)+(", "+lfarmortext))+((", "+(lfshieldtext.length>0?lfshieldtext+", ":""))+(lfdrivetext+")</i>")));
 return rv;
}

//START SPECIAL WEAPONS

function tsw_assaultshuttles(lp,wpower)
{
 rv="boarding shuttle";
 var count=1+Math.floor(Math.pow(wpower,0.2)*Math.pow(lp.r.sd(0,1),3));
 if(count%2==1 && count>1 && lp.r.sb(0.6))
 {
  count--;
 }
 if(count>1)
 {
  rv=(count+"x ")+(rv+"s");
 }
 return rv;
}

function tsw_minelayer(lp,wpower)
{
 var rv=wep_explosivetypes[lp.r.schoose(lp.c["wep explosivetypec"])]+" minelayer";
 return rv;
}

function tsw_tractorbeam(lp,wpower) {return "tractor beam";}

function tsw_buzzsaw(lp,wpower) {return "buzzsaw launcher";}

function tsw_quantumdestructor(lp,wpower) {return "quantum destructor";}

function tsw_acid(lp,wpower) {return "acid sprayer";}

function tsw_freezeray(lp,wpower) {return "freezing ray";}

function tsw_claw(lp,wpower) {return "giant mechanical claw";}

function tsw_drill(lp,wpower) {return "giant drill";}

function tsw_nanomachines(lp,wpower) {return "nanodrone swarm";}

eq_fireballtypes=null;
function tsw_fireball(lp,wpower)
{
 console.log(lp.f.bs+", "+lp.bs);
 if(lp.c["eq fireballtypec"]==null)
 {
  var wfe=4; //Default fireball faction exponent.
  eq_fireballtypes=[];
  lp.c["eq fireballtypec"]=[];
  eq_fireballtypes.push("burning hydrogen"); lp.c["eq fireballtypec"].push(1*Math.pow(lp.f.r.hd(0.1,1,"eq fireballtype c"+eq_fireballtypes.length),wfe));
  eq_fireballtypes.push("burning methane"); lp.c["eq fireballtypec"].push(0.7*Math.pow(lp.f.r.hd(0,1,"eq fireballtype c"+eq_fireballtypes.length),wfe));
  eq_fireballtypes.push("burning kerosene"); lp.c["eq fireballtypec"].push(0.2*Math.pow(lp.f.r.hd(0,1,"eq fireballtype c"+eq_fireballtypes.length),wfe));
  eq_fireballtypes.push("hydrogen fusion"); lp.c["eq fireballtypec"].push(0.8*Math.pow(lp.f.r.hd(0.1,1,"eq fireballtype c"+eq_fireballtypes.length),wfe));
  eq_fireballtypes.push("deuterium fusion"); lp.c["eq fireballtypec"].push(0.3*Math.pow(lp.f.r.hd(0,1,"eq fireballtype c"+eq_fireballtypes.length),wfe));
  eq_fireballtypes.push("tritium fusion"); lp.c["eq fireballtypec"].push(0.2*Math.pow(lp.f.r.hd(0,1,"eq fireballtype c"+eq_fireballtypes.length),wfe));
  eq_fireballtypes.push("helium-3 fusion"); lp.c["eq fireballtypec"].push(0.3*Math.pow(lp.f.r.hd(0,1,"eq fireballtype c"+eq_fireballtypes.length),wfe));
  eq_fireballtypes.push("helium fusion"); lp.c["eq fireballtypec"].push(0.4*Math.pow(lp.f.r.hd(0.01,1,"eq fireballtype c"+eq_fireballtypes.length),wfe));
  eq_fireballtypes.push("plasma"); lp.c["eq fireballtypec"].push(0.4*Math.pow(lp.f.r.hd(0.05,1,"eq fireballtype c"+eq_fireballtypes.length),wfe));
  eq_fireballtypes.push("antimatter"); lp.c["eq fireballtypec"].push(1*Math.pow(lp.f.r.hd(0.02,1,"eq fireballtype c"+eq_fireballtypes.length),wfe));
 }
 return (eq_fireballtypes[lp.r.schoose(lp.c["eq fireballtypec"])]+" fireball launcher");
}

function tsw_stasis(lp,wpower) {return "stasis field projector";}

function tsw_lightning(lp,wpower)
{
 var voltage=Math.floor(wpower*lp.r.sd(10000,20000));
 var power=voltage+"V";
 if(voltage>=2000000000000)
 {
  power=Math.floor(voltage/1000000000000)+"TV";
 }
 else if(voltage>=2000000000)
 {
  power=Math.floor(voltage/1000000000)+"GV";
 }
 else if(voltage>=2000000)
 {
  power=Math.floor(voltage/1000000)+"MV";
 }
 else if(voltage>=2000)
 {
  power=Math.floor(voltage/1000)+"KV";
 }
 return (power+" lightning cannon");
}

function tsw_beamlance(lp,wpower)
{
 var lenergytype=wep_beamenergytypes[lp.r.schoose(lp.c["wep beamenergytypec"])];
 return (lenergytype+" lance");
}

function tsw_beamvortex(lp,wpower)
{
 var lenergytype=wep_beamenergytypes[lp.r.schoose(lp.c["wep beamenergytypec"])];
 return (lenergytype+" vortex cannon");
}

function text_specialweapon(lp,wpower)
{
 return wep_specialtypes[lp.r.schoose(lp.c["wep specialtypec"])](lp,wpower);
}

//END SPECIAL WEAPONS

function text_weapon(lp,wpower)
{
 var wtypeid=lp.r.schoose(lp.c["wep basetypec"]);
 var wtype=wep_basetypes[wtypeid];
 return wtype(lp,wpower);
}

function text_weapons(lp)
{
 if(lp.c["wep basetypec"]==null)
 {
  setup_weapons(lp);
 }
 var rv="<b>Armament:</b><br>"
 if(lp.c["militariness"]<lp.r.sd(0.1,0.3) && lp.r.sb(1-(lp.c["militariness"]*4)))
 {
  rv=rv+"<i>none</i><br>";
  return rv;
 }
 lp.c["total weapon power"]=lp.r.sd(0.5,1)*lp.c["militariness"]*lp.size3*lp.f.r.hd(0.5,1,"total weapon power");
 var twpremaining=lp.c["total weapon power"];
 var weaponchance=1-(1/(((lp.r.sd(0,20)+(Math.pow(lp.c["militariness"],3)*80)+Math.pow(lp.size,0.7))*0.002)+1));
 var weaponcount=lp.r.si(1,2)+(lp.r.sb((lp.size*lp.c["militariness"])/150)?lp.r.si(1,2):0)+lp.r.sseq(weaponchance,10);
 var weapons=[];
 if(lp.t_type.toLowerCase().indexOf("carrier")>=0) //Special provision - carriers always have at least one fighter.
 {
  var nw=text_fighter(lp,twpremaining*lp.r.sd(0.4,0.9));
  weapons.push(nw);
  rv=rv+(nw+"<br>");
  twpremaining*=lp.r.sd(0.4,0.8);
 }
 for(var tries=0;(tries<10000 && weapons.length<weaponcount && twpremaining>=100);tries++)
 {
  var wpower=twpremaining*Math.pow(lp.r.sd(0.3,1),2);
  var nw=text_weapon(lp,wpower);
  if(!arraycontains(weapons,nw))
  {
   weapons.push(nw);
   twpremaining-=wpower;
   rv=rv+(nw+"<br>");
  }
 }
 return rv;
}

//END WEAPONS

//START EQUIPMENT

var eq_basetypes=null;

function setup_equipment(lp)
{
 var qfe=3; //Default equipment faction exponent.
 eq_basetypes=[];
 lp.c["eq basetypec"]=[];
 eq_basetypes.push(tq_cargobay); lp.c["eq basetypec"].push(1*((lp.t_type.indexOf("freighter")>=0)?4:1)*Math.pow(lp.f.r.hd(0.1,1,"eq basetype c"+eq_basetypes.length),qfe));
 eq_basetypes.push(tq_cargotank); lp.c["eq basetypec"].push(1*((lp.t_type.indexOf("tanker")>=0)?4:1)*((2-lp.c["militariness"])/2)*Math.pow(lp.f.r.hd(0.1,1,"eq basetype c"+eq_basetypes.length),qfe));
 eq_basetypes.push(tq_medbay); lp.c["eq basetypec"].push(0.2*((lp.t_type.indexOf("medical")>=0)?10:1)*((lp.t_type.indexOf("colony")>=0 || lp.t_type.indexOf("disaster relief")>=0)?4:1)*Math.pow(lp.f.r.hd(0.1,1,"eq basetype c"+eq_basetypes.length),qfe));
 eq_basetypes.push(tq_autodoc); lp.c["eq basetypec"].push(0.1*((lp.t_type.indexOf("medical")>=0)?20:1)*((lp.t_type.indexOf("disaster relief")>=0)?5:1)*Math.pow(lp.f.r.hd(0,1,"eq basetype c"+eq_basetypes.length),qfe));
 eq_basetypes.push(tq_cryochamber); lp.c["eq basetypec"].push(0.02*((1.5-lp.c["militariness"])/1.5)*((lp.t_type.indexOf("colony")>=0)?30:1)*Math.pow(lp.f.r.hd(0,1,"eq basetype c"+eq_basetypes.length),qfe));
 eq_basetypes.push(tq_researchlab); lp.c["eq basetypec"].push(0.2*((2-lp.c["militariness"])/2)*((lp.t_type.indexOf("colony")>=0 || lp.t_type.indexOf("medical")>=0 || lp.t_type.indexOf("scout")>=0)?10:1)*((lp.t_type.indexOf("research")>=0)?30:1)*Math.pow(lp.f.r.hd(0.2,1,"eq basetype c"+eq_basetypes.length),qfe));
 eq_basetypes.push(tq_scanner); lp.c["eq basetypec"].push(0.5*((1+lp.c["militariness"])/2)*((lp.t_type.indexOf("scout")>=0 || lp.t_type.indexOf("research")>=0)?3:1)*Math.pow(lp.f.r.hd(0.1,1,"eq basetype c"+eq_basetypes.length),qfe));
 eq_basetypes.push(tq_factory); lp.c["eq basetypec"].push(0.5*((lp.t_type.indexOf("factory")>=0 || lp.t_type.indexOf("industrial")>=0)?4:1)*((lp.t_type.indexOf("colony")>=0 || lp.t_type.indexOf("mining")>=0 || lp.t_type.indexOf("construction")>=0)?2:1)*((2-lp.c["militariness"])/2)*Math.pow(lp.f.r.hd(0.1,1,"eq basetype c"+eq_basetypes.length),qfe));
 eq_basetypes.push(tq_crewservices); lp.c["eq basetypec"].push(0.8*((1.1-lp.c["militariness"])/1.1)*((lp.t_type.indexOf("liner")>=0 || lp.t_type.indexOf("yacht")>=0)?3:1)*((lp.t_type.indexOf("ferry")>=0 || lp.t_type.indexOf("colony")>=0)?2:1)*Math.pow(lp.f.r.hd(0.1,1,"eq basetype c"+eq_basetypes.length),qfe));
 eq_basetypes.push(tq_prison); lp.c["eq basetypec"].push((0.000001+((lp.t_type.indexOf("prison")>=0)?0.7:0)+((lp.t_type.indexOf("colony")>=0)?0.2:0)+((lp.t_type.indexOf("yacht")>=0)?0.05:0))*Math.pow(lp.f.r.hd(0,1,"eq basetype c"+eq_basetypes.length),qfe));
 eq_basetypes.push(tq_hydroponic); lp.c["eq basetypec"].push(0.05*((1.1-lp.c["militariness"])/1.1)*((lp.t_type.indexOf("colony")>=0)?10:1)*((lp.t_type.indexOf("research")>=0)?3:1)*(lp.c["crew"]<=0?0.01:1)*Math.pow(lp.f.r.hd(0,1,"eq basetype c"+eq_basetypes.length),qfe));
 eq_basetypes.push(tq_ai); lp.c["eq basetypec"].push(0.4*Math.pow(lp.f.r.hd(0.01,1,"eq basetype c"+eq_basetypes.length),qfe));
 eq_basetypes.push(tq_selfrepair); lp.c["eq basetypec"].push(0.3*((1+lp.c["militariness"])/2)*Math.pow(lp.f.r.hd(0.01,1,"eq basetype c"+eq_basetypes.length),qfe));
 eq_basetypes.push(tq_selfdestruct); lp.c["eq basetypec"].push(0.2*((0.1+lp.c["militariness"])/1.1)*Math.pow(lp.f.r.hd(0,1,"eq basetype c"+eq_basetypes.length),qfe));
 eq_basetypes.push(tq_lifeboat); lp.c["eq basetypec"].push(0.6*(lp.c["crew"]>0?1:0.000001)*((lp.t_type.indexOf("ferry")>=0 || lp.t_type.indexOf("liner")>=0 || lp.t_type.indexOf("yacht")>=0)?3:1)*Math.pow(lp.f.r.hd(0,1,"eq basetype c"+eq_basetypes.length),qfe));
 eq_basetypes.push(tq_ramscoop); lp.c["eq basetypec"].push(0.05*((lp.t_power.indexOf("fusion")>=0 || lp.t_drive.indexOf("fusion")>=0)?5:1)*Math.pow(lp.f.r.hd(0,1,"eq basetype c"+eq_basetypes.length),qfe));
 eq_basetypes.push(tq_flare); lp.c["eq basetypec"].push(0.1*Math.pow(lp.f.r.hd(0,1,"eq basetype c"+eq_basetypes.length),qfe));
 eq_basetypes.push(tq_jammer); lp.c["eq basetypec"].push(0.1*Math.pow(lp.f.r.hd(0,1,"eq basetype c"+eq_basetypes.length),qfe));
 eq_basetypes.push(tq_afterburner); lp.c["eq basetypec"].push(0.2*(lp.t_drive.indexOf("rocket")>=0?1:0)*Math.pow(lp.f.r.hd(0,1,"eq basetype c"+eq_basetypes.length),qfe));
 eq_basetypes.push(tq_cargopod); lp.c["eq basetypec"].push(0.3*((lp.t_type.indexOf("freighter")>=0)?5:1)*Math.pow(lp.f.r.hd(0,1,"eq basetype c"+eq_basetypes.length),qfe));
 eq_basetypes.push(tq_cloak); lp.c["eq basetypec"].push(0.2*((0.2+lp.c["militariness"])/1.2)*Math.pow(lp.f.r.hd(0,1,"eq basetype c"+eq_basetypes.length),qfe));
}

function tq_cargobay(lp)
{
 var lsize=Math.floor(0.12*((lp.t_type.indexOf("freighter")>=0)?4:1)*lp.r.sd(0.05,1)*lp.size3*(lp.f.c["cargo bay size"]==null?lp.f.c["cargo bay size"]=lp.f.r.hd(0.3,1,"cargo bay size"):lp.f.c["cargo bay size"]));
 var log10=Math.log(lsize)*Math.LOG10E;
 if(log10>=1)
 {
  lsize-=lsize%Math.pow(10,Math.floor(lp.r.sd(0.25*log10,log10)));
 }
 return (lsize+"m<sup>3</sup> cargo bay");
}

function tq_cargotank(lp)
{
 var lsize=Math.floor(0.08*((lp.t_type.indexOf("tanker")>=0)?8:1)*lp.r.sd(0.05,1)*lp.size3*(lp.f.c["cargo tank size"]==null?lp.f.c["cargo tank size"]=lp.f.r.hd(0.3,1,"cargo tank size"):lp.f.c["cargo tank size"]));
 var log10=Math.log(lsize)*Math.LOG10E;
 if(log10>=1)
 {
  lsize-=lsize%Math.pow(10,Math.floor(lp.r.sd(0.3*log10,log10)));
 }
 var fluidtype=["fluid","gas","compressed gas"][lp.r.schoose([1,0.4,0.4])];
 return ((lsize+"m<sup>3</sup> ")+(fluidtype+" cargo tank"));
}

function tq_medbay(lp)
{
 var lsize=Math.floor(0.04*lp.r.sd(0.1,1)*((lp.t_type.indexOf("medical")>=0)?10:1)*lp.size2*(lp.f.c["medbay size"]==null?lp.f.c["medbay size"]=lp.f.r.hd(0.3,1,"medbay size"):lp.f.c["medbay size"]));
 var log10=Math.log(lsize)*Math.LOG10E;
 if(log10>=1)
 {
  lsize-=lsize%Math.pow(10,Math.floor(lp.r.sd(0.25*log10,log10)));
 }
 return (lsize+"m<sup>2</sup> medical bay");
}

function tq_autodoc(lp)
{
 var count=1+(lp.r.sb(0.2)?1:0)+Math.floor(0.0005*((lp.t_type.indexOf("medical")>=0)?10:1)*Math.pow(lp.r.sd(0,1),3)*lp.size2*(lp.f.c["autodoc count"]==null?lp.f.c["autodoc count"]=Math.pow(lp.f.r.hd(0,1,"autodoc count"),3):lp.f.c["autodoc count"]));
 if(count>1)
 {
  return (count+"x autodoc units");
 }
 else
 {
  var mod=["","large ","specialized ","nanotech ","nanoregenerative ","nanoreconstructive "][lp.r.schoose([1,0.2,0.5,0.2,0.1,0.1])];
  return (mod+"autodoc unit");
 }
}

function tq_cryochamber(lp)
{
 var count=1+(lp.r.sb(0.2)?1:0)+Math.floor(0.001*((lp.t_type.indexOf("medical")>=0)?10:1)*Math.pow(lp.r.sd(0,1),2)*lp.size2*(lp.f.c["cryochamber count"]==null?lp.f.c["cryochamber count"]=Math.pow(lp.f.r.hd(0,1,"cryochamber count"),2):lp.f.c["cryochamber count"]));
 if(count>1)
 {
  return (count+"x cryo hibernation chambers");
 }
 else
 {
  return "cryo hibernation chamber";
 }
}

var eq_labtypes=[];
function tq_researchlab(lp)
{
 if(lp.c["eq labtypec"]==null)
 {
  var qfe=3; //Default equipment faction exponent.
  eq_labtypes=[];
  lp.c["eq labtypec"]=[];
  eq_labtypes.push("general science"); lp.c["eq labtypec"].push(1*Math.pow(lp.f.r.hd(0.1,1,"eq labtype c"+eq_labtypes.length),qfe));
  eq_labtypes.push("physics"); lp.c["eq labtypec"].push(0.4*Math.pow(lp.f.r.hd(0,1,"eq labtype c"+eq_labtypes.length),qfe));
  eq_labtypes.push("particle physics"); lp.c["eq labtypec"].push(0.1*Math.pow(lp.f.r.hd(0,1,"eq labtype c"+eq_labtypes.length),qfe));
  eq_labtypes.push("quantum physics"); lp.c["eq labtypec"].push(0.1*Math.pow(lp.f.r.hd(0,1,"eq labtype c"+eq_labtypes.length),qfe));
  eq_labtypes.push("chemistry"); lp.c["eq labtypec"].push(0.5*Math.pow(lp.f.r.hd(0,1,"eq labtype c"+eq_labtypes.length),qfe));
  eq_labtypes.push("organic chemistry"); lp.c["eq labtypec"].push(0.1*Math.pow(lp.f.r.hd(0,1,"eq labtype c"+eq_labtypes.length),qfe));
  eq_labtypes.push("biology"); lp.c["eq labtypec"].push(0.3*Math.pow(lp.f.r.hd(0,1,"eq labtype c"+eq_labtypes.length),qfe));
  eq_labtypes.push("botany"); lp.c["eq labtypec"].push(0.1*Math.pow(lp.f.r.hd(0,1,"eq labtype c"+eq_labtypes.length),qfe));
  eq_labtypes.push("zoology"); lp.c["eq labtypec"].push(0.05*Math.pow(lp.f.r.hd(0,1,"eq labtype c"+eq_labtypes.length),qfe));
  eq_labtypes.push("mycology"); lp.c["eq labtypec"].push(0.02*Math.pow(lp.f.r.hd(0,1,"eq labtype c"+eq_labtypes.length),qfe));
  eq_labtypes.push("agricultural science"); lp.c["eq labtypec"].push(0.01*((lp.t_type.indexOf("colony")>=0)?20:1)*Math.pow(lp.f.r.hd(0,1,"eq labtype c"+eq_labtypes.length),qfe));
  eq_labtypes.push("marine biology"); lp.c["eq labtypec"].push(0.01*Math.pow(lp.f.r.hd(0,1,"eq labtype c"+eq_labtypes.length),qfe));
  eq_labtypes.push("xenobiology"); lp.c["eq labtypec"].push(0.01*Math.pow(lp.f.r.hd(0,1,"eq labtype c"+eq_labtypes.length),qfe));
  eq_labtypes.push("astrobiology"); lp.c["eq labtypec"].push(0.2*((lp.t_type.indexOf("colony")>=0)?10:1)*Math.pow(lp.f.r.hd(0,1,"eq labtype c"+eq_labtypes.length),qfe));
  eq_labtypes.push("psychology"); lp.c["eq labtypec"].push(0.02*Math.pow(lp.f.r.hd(0,1,"eq labtype c"+eq_labtypes.length),qfe));
  eq_labtypes.push("sociology"); lp.c["eq labtypec"].push(0.02*Math.pow(lp.f.r.hd(0,1,"eq labtype c"+eq_labtypes.length),qfe));
  eq_labtypes.push("space science"); lp.c["eq labtypec"].push(0.2*Math.pow(lp.f.r.hd(0,1,"eq labtype c"+eq_labtypes.length),qfe));
  eq_labtypes.push("planetary science"); lp.c["eq labtypec"].push(0.4*((lp.t_type.indexOf("colony")>=0)?10:1)*Math.pow(lp.f.r.hd(0,1,"eq labtype c"+eq_labtypes.length),qfe));
  eq_labtypes.push("xenoarchaeology"); lp.c["eq labtypec"].push(0.1*Math.pow(lp.f.r.hd(0,1,"eq labtype c"+eq_labtypes.length),qfe));
  eq_labtypes.push("xenolinguistics"); lp.c["eq labtypec"].push(0.02*Math.pow(lp.f.r.hd(0,1,"eq labtype c"+eq_labtypes.length),qfe));
  eq_labtypes.push("medical research"); lp.c["eq labtypec"].push(0.05*((lp.t_type.indexOf("medical")>=0)?50:1)*Math.pow(lp.f.r.hd(0.1,1,"eq labtype c"+eq_labtypes.length),qfe));
  eq_labtypes.push("engineering"); lp.c["eq labtypec"].push(1*Math.pow(lp.f.r.hd(0.1,1,"eq labtype c"+eq_labtypes.length),qfe));
  eq_labtypes.push("weapons engineering"); lp.c["eq labtypec"].push(0.2*((1+lp.c["militariness"])/2)*Math.pow(lp.f.r.hd(0,1,"eq labtype c"+eq_labtypes.length),qfe));
  eq_labtypes.push("robotics engineering"); lp.c["eq labtypec"].push(0.05*Math.pow(lp.f.r.hd(0,1,"eq labtype c"+eq_labtypes.length),qfe));
  eq_labtypes.push("computer engineering"); lp.c["eq labtypec"].push(0.05*Math.pow(lp.f.r.hd(0,1,"eq labtype c"+eq_labtypes.length),qfe));
 }
 return ("onboard "+eq_labtypes[lp.r.schoose(lp.c["eq labtypec"])]+" lab");
}

var eq_scannertypes=[];
var eq_scannermods=[];
function tq_scanner(lp)
{
 if(lp.c["eq scannertypec"]==null)
 {
  var qfe=5; //Default equipment faction exponent.
  eq_scannertypes=[];
  lp.c["eq scannertypec"]=[];
  eq_scannertypes.push("infrared"); lp.c["eq scannertypec"].push(1*Math.pow(lp.f.r.hd(0.1,1,"eq scannertype c"+eq_scannertypes.length),qfe));
  eq_scannertypes.push("x-ray"); lp.c["eq scannertypec"].push(0.6*Math.pow(lp.f.r.hd(0,1,"eq scannertype c"+eq_scannertypes.length),qfe));
  eq_scannertypes.push("gamma ray"); lp.c["eq scannertypec"].push(0.3*Math.pow(lp.f.r.hd(0,1,"eq scannertype c"+eq_scannertypes.length),qfe));
  eq_scannertypes.push("neutrino"); lp.c["eq scannertypec"].push(0.5*Math.pow(lp.f.r.hd(0,1,"eq scannertype c"+eq_scannertypes.length),qfe));
  eq_scannertypes.push("gravity wave"); lp.c["eq scannertypec"].push(0.1*Math.pow(lp.f.r.hd(0,1,"eq scannertype c"+eq_scannertypes.length),qfe));
  eq_scannertypes.push("quantum"); lp.c["eq scannertypec"].push(0.4*Math.pow(lp.f.r.hd(0,1,"eq scannertype c"+eq_scannertypes.length),qfe));
  eq_scannertypes.push("tachyon"); lp.c["eq scannertypec"].push(0.7*Math.pow(lp.f.r.hd(0,1,"eq scannertype c"+eq_scannertypes.length),qfe));
  eq_scannertypes.push("hyperspace"); lp.c["eq scannertypec"].push(0.6*Math.pow(lp.f.r.hd(0,1,"eq scannertype c"+eq_scannertypes.length),qfe));
  eq_scannertypes.push("subspace"); lp.c["eq scannertypec"].push(0.3*Math.pow(lp.f.r.hd(0,1,"eq scannertype c"+eq_scannertypes.length),qfe));
  var qfe=3; //Default equipment faction exponent.
  eq_scannermods=[];
  lp.c["eq scannermodc"]=[];
  eq_scannermods.push("ultra-sensitive"); lp.c["eq scannermodc"].push(1*Math.pow(lp.f.r.hd(0.1,1,"eq scannermod c"+eq_scannermods.length),qfe));
  eq_scannermods.push("long-range"); lp.c["eq scannermodc"].push(1*Math.pow(lp.f.r.hd(0.1,1,"eq scannermod c"+eq_scannermods.length),qfe));
  eq_scannermods.push("wide-area"); lp.c["eq scannermodc"].push(0.7*Math.pow(lp.f.r.hd(0.1,1,"eq scannermod c"+eq_scannermods.length),qfe));
 }
 return ((eq_scannermods[lp.r.schoose(lp.c["eq scannermodc"])]+" ")+(eq_scannertypes[lp.r.schoose(lp.c["eq scannertypec"])]+" scanner"));
}

var eq_factorytypes=[];
function tq_factory(lp)
{
 if(lp.c["eq factorytypec"]==null)
 {
  var qfe=3; //Default equipment faction exponent.
  eq_factorytypes=[];
  lp.c["eq factorytypec"]=[];
  eq_factorytypes.push("internal factory"); lp.c["eq factorytypec"].push(1*Math.pow(lp.f.r.hd(0.2,1,"eq factorytype c"+eq_factorytypes.length),qfe));
  eq_factorytypes.push("onboard manufacturing unit"); lp.c["eq factorytypec"].push(1*Math.pow(lp.f.r.hd(0.2,1,"eq factorytype c"+eq_factorytypes.length),qfe));
  eq_factorytypes.push("onboard fabrication unit"); lp.c["eq factorytypec"].push(0.8*Math.pow(lp.f.r.hd(0.1,1,"eq factorytype c"+eq_factorytypes.length),qfe));
  eq_factorytypes.push("internal nanoforge"); lp.c["eq factorytypec"].push(0.3*Math.pow(lp.f.r.hd(0,1,"eq factorytype c"+eq_factorytypes.length),qfe));
  eq_factorytypes.push("onboard ore refinery"); lp.c["eq factorytypec"].push(0.2*((lp.t_type.indexOf("mining")>=0)?3:1)*Math.pow(lp.f.r.hd(0.2,1,"eq factorytype c"+eq_factorytypes.length),qfe));
  eq_factorytypes.push("onboard gas refinery"); lp.c["eq factorytypec"].push(0.1*((lp.t_type.indexOf("mining")>=0)?2:1)*Math.pow(lp.f.r.hd(0.2,1,"eq factorytype c"+eq_factorytypes.length),qfe));
  eq_factorytypes.push("ore processing unit"); lp.c["eq factorytypec"].push(0.1*((lp.t_type.indexOf("mining")>=0)?2:1)*Math.pow(lp.f.r.hd(0.2,1,"eq factorytype c"+eq_factorytypes.length),qfe));
  eq_factorytypes.push("food processing unit"); lp.c["eq factorytypec"].push(0.02*Math.pow(lp.f.r.hd(0,1,"eq factorytype c"+eq_factorytypes.length),qfe));
  eq_factorytypes.push("robotic construction swarm"); lp.c["eq factorytypec"].push(0.1*Math.pow(lp.f.r.hd(0,1,"eq factorytype c"+eq_factorytypes.length),qfe));
  eq_factorytypes.push("nanofabricator swarm"); lp.c["eq factorytypec"].push(0.1*Math.pow(lp.f.r.hd(0,1,"eq factorytype c"+eq_factorytypes.length),qfe));
  eq_factorytypes.push("metal recycling unit"); lp.c["eq factorytypec"].push(0.2*Math.pow(lp.f.r.hd(0,1,"eq factorytype c"+eq_factorytypes.length),qfe));
  eq_factorytypes.push("water recycling unit"); lp.c["eq factorytypec"].push(0.1*Math.pow(lp.f.r.hd(0,1,"eq factorytype c"+eq_factorytypes.length),qfe));
  eq_factorytypes.push("sewage recycling unit"); lp.c["eq factorytypec"].push(0.1*Math.pow(lp.f.r.hd(0,1,"eq factorytype c"+eq_factorytypes.length),qfe));
  eq_factorytypes.push("onboard repair bay"); lp.c["eq factorytypec"].push(0.5*((1+lp.c["militariness"])/2)*Math.pow(lp.f.r.hd(0,1,"eq factorytype c"+eq_factorytypes.length),qfe));
 }
 return ((lp.r.sb((lp.size-120)/500)?"large ":"")+eq_factorytypes[lp.r.schoose(lp.c["eq factorytypec"])]);
}

var eq_crewservicetypes=[];
function tq_crewservices(lp)
{
 if(lp.c["eq crewservicetypec"]==null)
 {
  var qfe=3; //Default equipment faction exponent.
  eq_crewservicetypes=[];
  lp.c["eq crewservicetypec"]=[];
  eq_crewservicetypes.push("lounge"); lp.c["eq crewservicetypec"].push(1*clamp((lp.size-70)/200,0,1)*Math.pow(lp.f.r.hd(0.01,1,"eq crewservicetype c"+eq_crewservicetypes.length),qfe));
  eq_crewservicetypes.push("beverage bar"); lp.c["eq crewservicetypec"].push(0.4*clamp((lp.size-50)/150,0,1)*Math.pow(lp.f.r.hd(0,1,"eq crewservicetype c"+eq_crewservicetypes.length),qfe));
  eq_crewservicetypes.push("restaurant"); lp.c["eq crewservicetypec"].push(0.3*clamp((lp.size-80)/200,0,1)*Math.pow(lp.f.r.hd(0,1,"eq crewservicetype c"+eq_crewservicetypes.length),qfe));
  eq_crewservicetypes.push("cinema"); lp.c["eq crewservicetypec"].push(0.1*clamp((lp.size-120)/300,0,1)*Math.pow(lp.f.r.hd(0,1,"eq crewservicetype c"+eq_crewservicetypes.length),qfe));
  eq_crewservicetypes.push("exercise gym"); lp.c["eq crewservicetypec"].push(0.2*((1+lp.c["militariness"])/2)*Math.pow(lp.f.r.hd(0,1,"eq crewservicetype c"+eq_crewservicetypes.length),qfe));
  eq_crewservicetypes.push("holodeck"); lp.c["eq crewservicetypec"].push(0.1*Math.pow(lp.f.r.hd(0,1,"eq crewservicetype c"+eq_crewservicetypes.length),qfe));
  eq_crewservicetypes.push("concert hall"); lp.c["eq crewservicetypec"].push(0.04*clamp((lp.size-120)/300,0,1)*Math.pow(lp.f.r.hd(0,1,"eq crewservicetype c"+eq_crewservicetypes.length),qfe));
  eq_crewservicetypes.push("dance hall"); lp.c["eq crewservicetypec"].push(0.02*clamp((lp.size-150)/300,0,1)*Math.pow(lp.f.r.hd(0,1,"eq crewservicetype c"+eq_crewservicetypes.length),qfe));
  eq_crewservicetypes.push("rave club"); lp.c["eq crewservicetypec"].push(0.02*clamp((lp.size-120)/250,0,1)*Math.pow(lp.f.r.hd(0,1,"eq crewservicetype c"+eq_crewservicetypes.length),qfe));
  eq_crewservicetypes.push("massage parlor"); lp.c["eq crewservicetypec"].push(0.01*Math.pow(lp.f.r.hd(0,1,"eq crewservicetype c"+eq_crewservicetypes.length),qfe));
  eq_crewservicetypes.push("theater"); lp.c["eq crewservicetypec"].push(0.01*clamp((lp.size-150)/300,0,1)*Math.pow(lp.f.r.hd(0,1,"eq crewservicetype c"+eq_crewservicetypes.length),qfe));
  eq_crewservicetypes.push("casino"); lp.c["eq crewservicetypec"].push(0.1*clamp((lp.size-120)/300,0,1)*Math.pow(lp.f.r.hd(0,1,"eq crewservicetype c"+eq_crewservicetypes.length),qfe));
  eq_crewservicetypes.push("aquarium"); lp.c["eq crewservicetypec"].push(0.01*clamp((lp.size-30)/400,0,1)*Math.pow(lp.f.r.hd(0,1,"eq crewservicetype c"+eq_crewservicetypes.length),qfe));
  eq_crewservicetypes.push("botanical garden"); lp.c["eq crewservicetypec"].push(0.01*clamp((lp.size-80)/300,0,1)*Math.pow(lp.f.r.hd(0,1,"eq crewservicetype c"+eq_crewservicetypes.length),qfe));
  eq_crewservicetypes.push("swimming pool"); lp.c["eq crewservicetypec"].push(0.06*clamp((lp.size-150)/300,0,1)*Math.pow(lp.f.r.hd(0,1,"eq crewservicetype c"+eq_crewservicetypes.length),qfe));
  eq_crewservicetypes.push("petting zoo"); lp.c["eq crewservicetypec"].push(0.001*clamp((lp.size-100)/300,0,1)*Math.pow(lp.f.r.hd(0,1,"eq crewservicetype c"+eq_crewservicetypes.length),qfe));
  eq_crewservicetypes.push("maid cafe"); lp.c["eq crewservicetypec"].push(0.001*clamp((lp.size-80)/300,0,1)*Math.pow(lp.f.r.hd(0,1,"eq crewservicetype c"+eq_crewservicetypes.length),qfe));
 }
 return ("onboard "+eq_crewservicetypes[lp.r.schoose(lp.c["eq crewservicetypec"])]);
}

function tq_prison(lp)
{
 var count=1+(lp.r.sb(0.2)?1:0)+Math.floor(0.001*((lp.t_type.indexOf("prison")>=0)?10:1)*lp.r.sd(0.2,1)*lp.size2*(lp.f.c["prison cell count"]==null?lp.f.c["prison cell count"]=lp.f.r.hd(0.2,1,"prison cell count"):lp.f.c["prison cell count"]));
 if(count>2 && count%2==1 && lp.r.sb(0.7))
 {
  count--;
 }
 rv=["prison cell","high-security prison cell","solitary-confinement prison cell","cryogenic prison cell"][lp.r.schoose([1,0.3,0.1,0.1])];
 if(count>1)
 {
  rv=(count+"x ")+(rv+"s");
 }
 return rv;
}

function tq_hydroponic(lp)
{
 var lsize=Math.floor(0.001*((lp.t_type.indexOf("colony")>=0)?10:1)*lp.r.sd(0.1,1)*lp.size3*(lp.f.c["hydroponic farm size"]==null?lp.f.c["hydroponic farm size"]=lp.f.r.hd(0.4,1,"hydroponic farm size"):lp.f.c["hydroponic farm size"]));
 var log10=Math.log(lsize)*Math.LOG10E;
 if(log10>=1)
 {
  lsize-=lsize%Math.pow(10,Math.floor(lp.r.sd(0.1*log10,log10)));
 }
 return (lsize+"m<sup>3</sup> onboard hydroponic farm");
}

var eq_aitypes=null;
function tq_ai(lp)
{
 if(lp.c["eq aitypec"]==null)
 {
  var qfe=5; //Default equipment faction exponent.
  eq_aitypes=[];
  lp.c["eq aitypec"]=[];
  eq_aitypes.push("onboard AI"); lp.c["eq aitypec"].push(1*Math.pow(lp.f.r.hd(0.1,1,"eq aitype c"+eq_aitypes.length),qfe));
  eq_aitypes.push("central AI"); lp.c["eq aitypec"].push(1*Math.pow(lp.f.r.hd(0.1,1,"eq aitype c"+eq_aitypes.length),qfe));
  eq_aitypes.push("electronic supercomputer"); lp.c["eq aitypec"].push(0.5*Math.pow(lp.f.r.hd(0,1,"eq aitype c"+eq_aitypes.length),qfe));
  eq_aitypes.push("positronic supercomputer"); lp.c["eq aitypec"].push(0.2*Math.pow(lp.f.r.hd(0,1,"eq aitype c"+eq_aitypes.length),qfe));
  eq_aitypes.push("quantum supercomputer"); lp.c["eq aitypec"].push(0.1*Math.pow(lp.f.r.hd(0,1,"eq aitype c"+eq_aitypes.length),qfe));
  eq_aitypes.push("nanotech supercomputer"); lp.c["eq aitypec"].push(0.2*Math.pow(lp.f.r.hd(0,1,"eq aitype c"+eq_aitypes.length),qfe));
  eq_aitypes.push("nanoswarm AI"); lp.c["eq aitypec"].push(0.2*Math.pow(lp.f.r.hd(0,1,"eq aitype c"+eq_aitypes.length),qfe));
  eq_aitypes.push("central cybernetic brain"); lp.c["eq aitypec"].push(0.05*Math.pow(lp.f.r.hd(0,1,"eq aitype c"+eq_aitypes.length),qfe));
 }
 return eq_aitypes[lp.r.schoose(lp.c["eq aitypec"])];
}

function tq_selfrepair(lp) {return "internal self-repair unit";}

function tq_selfdestruct(lp)
{
 var explosivetype=["high-explosive","nuclear fission","thermonuclear","nuclear fusion","antimatter","nanotech"][lp.r.schoose([1,1,1,1,0.8,0.2])];
 return (explosivetype+" self-destruct mechanism");
}

function tq_lifeboat(lp)
{
 var ecrew=lp.c["crew"];
 if(lp.t_type.indexOf("ferry")>=0 || lp.t_type.indexOf("liner")>=0 || lp.t_type.indexOf("yacht")>=0)
 {
  ecrew+=Math.ceil(lp.r.sd(0.0001,0.0006)*lp.size3);
 }
 var capacity=lp.r.si(1,Math.max(2,Math.floor(Math.pow(ecrew,0.5)*(lp.f.c["lifeboat capacity"]==null?lp.f.c["lifeboat capacity"]=lp.f.r.hd(0.5,1.5,"lifeboat capacity"):lp.f.c["lifeboat capacity"]))));
 var required=ecrew*lp.r.sd(0.1,1.2)*(lp.f.c["lifeboats required"]==null?lp.f.c["lifeboats required"]=lp.f.r.hd(0,1,"lifeboats required"):lp.f.c["lifeboats required"]);
 var count=Math.ceil(required/capacity);
 if(count>2 && count%2==1 && lp.r.sb(0.8))
 {
  count++;
 }
 if(count>1)
 {
  return (count+"x escape pods <i>("+capacity+"-person capacity)</i>");
 }
 else
 {
  return ("escape pod <i>("+capacity+"-person capacity)</i>");
 }
}

function tq_ramscoop(lp) {return "ramscoop";}

function tq_flare(lp)
{
 var count=lp.r.si(1,4)+Math.floor(Math.pow(lp.r.sd(0.1,1),3)*lp.size*(lp.f.c["flare count"]==null?lp.f.c["flare count"]=Math.pow(lp.f.r.hd(0.1,1,"flare count"),2):lp.f.c["flare count"]));
 if(count>1)
 {
  return (count+"x decoy flare launchers");
 }
 else
 {
  return "decoy flare launcher";
 }
}

function tq_jammer(lp) {return "missile jammer";}

function tq_afterburner(lp) {return "afterburner";}

function tq_cargopod(lp)
{
 var lsize=Math.floor(0.02*((lp.t_type.indexOf("freighter")>=0)?4:1)*lp.r.sd(0.05,1)*lp.size3*(lp.f.c["cargo pod size"]==null?lp.f.c["cargo pod size"]=lp.f.r.hd(0.3,1,"cargo pod size"):lp.f.c["cargo pod size"]));
 var log10=Math.log(lsize)*Math.LOG10E;
 if(log10>=1)
 {
  lsize-=lsize%Math.pow(10,Math.floor(lp.r.sd(0.2*log10,log10)));
 }
 return (lsize+"m<sup>3</sup> external cargo pod");
}

function tq_cloak(lp) {return "cloaking device";}

function text_equipment(lp)
{
 if(lp.c["eq basetypec"]==null)
 {
  setup_equipment(lp);
 }
 var rv="";
 if(lp.f.c["special equipment chance"]==null)
 {
  lp.f.c["special equipment chance"]=Math.pow(lp.f.r.hd(0.1,1,"special equipment chance"),2);
 }
 var equipmentchance=1-(1/(((lp.r.sd(0,30)+Math.pow(lp.size,0.8))*0.02*lp.f.c["special equipment chance"])+1));
 var equipmentcount=(lp.r.sb(lp.f.c["special equipment chance"])?1:0)+(lp.r.sb(lp.f.c["special equipment chance"]*(lp.size/300))?1:0)+lp.r.sseq(equipmentchance,5);
 var equipments=[];
 if(lp.c["crew"]<=0)
 {
  var nq=tq_ai(lp); equipments.push(nq); rv=rv+(nq+"<br>"); equipmentcount++;
 }
 if(lp.t_type.indexOf("freighter")>=0 || ((lp.t_type.indexOf("mining")>=0 || lp.t_type.indexOf("salvage")>=0) && lp.r.sb(lp.f.c["mining/salvage cargo bay chance"]==null?lp.f.c["mining/salvage cargo bay chance"]=lp.r.hd(0,0.8,"mining/salvage cargo bay chance"):lp.f.c["mining/salvage cargo bay chance"])))
 {
  var nq=tq_cargobay(lp); equipments.push(nq); rv=rv+(nq+"<br>"); equipmentcount++;
 }
 if(lp.t_type.indexOf("tanker")>=0 || ((lp.t_type.indexOf("mining")>=0 || lp.t_type.indexOf("salvage")>=0) && lp.r.sb(lp.f.c["mining/salvage cargo tank chance"]==null?lp.f.c["mining/salvage cargo tank chance"]=lp.r.hd(-0.1,0.3,"mining/salvage cargo tank chance"):lp.f.c["mining/salvage cargo tank chance"])))
 {
  var nq=tq_cargotank(lp); equipments.push(nq); rv=rv+(nq+"<br>"); equipmentcount++;
 }
 if(lp.t_type.indexOf("research")>=0)
 {
  var nq=tq_researchlab(lp); equipments.push(nq); rv=rv+(nq+"<br>"); equipmentcount++;
 }
 if(lp.t_type.indexOf("medical")>=0)
 {
  var nq=tq_medbay(lp); equipments.push(nq); rv=rv+(nq+"<br>"); equipmentcount++;
 }
 if(lp.t_type.indexOf("factory")>=0 || lp.t_type.indexOf("industrial")>=0 || lp.t_type.indexOf("construction")>=0)
 {
  var nq=tq_factory(lp); equipments.push(nq); rv=rv+(nq+"<br>"); equipmentcount++;
  if(lp.r.sb((lp.size-180)/200))
  {
   nq=tq_factory(lp); equipments.push(nq); rv=rv+(nq+"<br>"); equipmentcount++;
  }
 }
 if(lp.t_type.indexOf("prison")>=0)
 {
  var nq=tq_prison(lp); equipments.push(nq); rv=rv+(nq+"<br>"); equipmentcount++;
 }
 if((lp.t_type.indexOf("ferry")>=0 || lp.t_type.indexOf("liner")>=0 || lp.t_type.indexOf("yacht")>=0) && lp.r.sb(0.6))
 {
  var nq=tq_lifeboat(lp); equipments.push(nq); rv=rv+(nq+"<br>"); equipmentcount++;
 }
 for(var tries=0;(tries<100 && equipments.length<equipmentcount);tries++)
 {
  var nq=eq_basetypes[lp.r.schoose(lp.c["eq basetypec"])](lp);
  if(!arraycontains(equipments,nq))
  {
   equipments.push(nq);
   rv=rv+(nq+"<br>");
  }
 }
 if(rv.length>0)
 {
  rv="<b>Special equipment:</b><br>"+rv;
 }
 return rv;
}

//END EQUIPMENT

//END TEXT GENERATION

//END SHIP



var baseurl="";

var defaultseedlength=16;

var currentfaction=null;
var currentship=null;

function renderstep()
{
 if(currentship!=null)
 {
  var done=false;
  for(var i=0;(i<renderspeed && !done);i++)
  {
   done=currentship.addcomponent();
  }
  if(done)
  {
   currentship.cfx.clearRect(currentship.hw+(currentship.w%2),0,currentship.w,currentship.h);
   currentship.cfx.scale(-1,1);
   currentship.cfx.drawImage(currentship.cf,0-currentship.w,0);
   currentship.generatetext();
   var c_out=element("o_canvas");
   c_out.setAttribute("width",currentship.w);
   c_out.setAttribute("height",currentship.h);
   var c_ctx=c_out.getContext("2d");
   c_ctx.clearRect(0,0,currentship.w,currentship.h);
   c_ctx.drawImage(currentship.cf,0,0);
   element("o_text").innerHTML=currentship.text;
   element("o_url").innerHTML="Link to this ship: <input type='text' style='width:80%;' value='"+(baseurl+"?"+"faction="+currentfaction.bs+"&ship="+currentship.bs)+"'>";
  }
  else
  {
   element("o_text").innerHTML="Rendering ("+Math.floor(currentship.getpcdone()*100)+"%)...";
   setTimeout("renderstep()",renderdelay);
  }
 }
}

function rendership()
{
 renderspeed=Math.max(1,parseInt(element("i_rspeed").value));
 var c_out=element("o_canvas");
 c_out.setAttribute("width",0);
 c_out.setAttribute("height",0);
 element("o_text").innerHTML="Rendering...";
 element("o_url").innerHTML="";
 var nfs=element("i_fseed").value;
 if(currentfaction==null)
 {
  currentfaction=new faction(nfs);
 }
 else if(currentfaction.s!=nfs)
 {
  currentfaction=new faction(nfs);
 }
 currentship=new ship(currentfaction,element("i_sseed").value);
 setTimeout("renderstep()",renderdelay);
}

function newship()
{
 element("i_sseed").value=randomseed(defaultseedlength,"_"+Math.random());
 rendership();
}

function newfaction()
{
 element("i_fseed").value=randomseed(defaultseedlength,"_"+Math.random());
 newship();
}

function setup()
{
 var url=window.location.href;
 var qmi=url.indexOf("?");
 if(qmi>=0)
 {
  baseurl=url.substring(0,qmi);
  var ami=url.indexOf("&");
  if(ami>=0)
  {
   var fpart=url.substring(qmi+1,ami);
   var spart=url.substring(ami+1);
   if(fpart.startsWith("faction=") && spart.startsWith("ship="))
   {
    element("i_fseed").value=fpart.substring(8);
    element("i_sseed").value=spart.substring(5);
    rendership();
   }
  }
  else
  {
   newfaction();
  }
 }
 else
 {
  baseurl=url;
  newfaction();
 }
}

window.onload=setup;

//START SEARCH

var searching=false;
var searchtries=0;
var searchtext="";
var searchnewfaction=true;
var searchtimeout=null;

function continuesearch()
{
 var nfs;
 if(searchnewfaction)
 {
  nfs=randomseed(defaultseedlength,"_"+Math.random());
  currentfaction=new faction(nfs);
 }
 else
 {
  nfs=element("i_fseed").value;
 }
 var nss=randomseed(defaultseedlength,"_"+Math.random());
 currentship=new ship(currentfaction,nss);
 currentship.generatetext();
 if(currentship.text.toLowerCase().indexOf(searchtext)>=0)
 {
  searching=false;
  element("i_fseed").value=nfs;
  element("i_sseed").value=nss;
  rendership();
 }
 else
 {
  searchtries++;
  element("o_text").innerHTML="Searching ("+searchtries+(searchtries==1?" try)...":" tries)...");
  searchtimeout=setTimeout(continuesearch,renderdelay);
 }
}

function startsearch(p_text,p_newfaction)
{
 if(searchtimeout!=null)
 {
  clearTimeout(searchtimeout);
  searchtimeout=null;
 }
 searchnewfaction=p_newfaction;
 if(p_text==null)
 {
  searchtext=prompt("Enter text to search for:",searchtext).toLowerCase();
 }
 else
 {
  searchtext=p_text.toLowerCase();
 }
 searching=true;
 searchtries=0;
 var c_out=element("o_canvas");
 c_out.setAttribute("width",1);
 c_out.setAttribute("height",1);
 setTimeout(continuesearch,renderdelay);
}

//END SEARCH

</script>
</HEAD>
<BODY bgcolor="#000000">
<font size="2" face="Arial;sans-serif" color="#CCCCCC">
<center>
Faction seed: <input type="text" id="i_fseed" value="0"><br><br>
Ship seed: <input type="text" id="i_sseed" value="0"><br><br>
Render speed: <input type="text" id="i_rspeed" value="100"><br><br>
<input type="button" value="Render this ship" onclick="rendership()"> <input type="button" value="Generate new ship (same faction)" onclick="newship()"> <input type="button" value="Generate new ship (new faction)" onclick="newfaction()"><br>
<input type="button" value="Search (same faction)" onclick="startsearch(null,false)"> <input type="button" value="Search (new faction)" onclick="startsearch(null,true)"><br><br><br>
<table style="width:1000px">
<tr>
<td style="width:50%;vertical-align:middle;text-align:center;"><canvas id="o_canvas" width=0 height=0></canvas></td>
<td style="width:50%;vertical-align:middle;"><a id="o_text"></a></td>
</tr>
</table>
<br><br><br><br>
<a id="o_url"></a><br><br>
</center>
</font>
</BODY>
</HTML>